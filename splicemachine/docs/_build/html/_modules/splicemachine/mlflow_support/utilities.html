

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>splicemachine.mlflow_support.utilities &mdash; Splice MLManager  documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> Splice MLManager
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../splicemachine.html">splicemachine package</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Splice MLManager</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>splicemachine.mlflow_support.utilities</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for splicemachine.mlflow_support.utilities</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">environ</span> <span class="k">as</span> <span class="n">env_vars</span><span class="p">,</span> <span class="n">popen</span> <span class="k">as</span> <span class="n">rbash</span><span class="p">,</span> <span class="n">system</span> <span class="k">as</span> <span class="n">bash</span><span class="p">,</span> <span class="n">remove</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">getsizeof</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">rmtree</span>
<span class="kn">from</span> <span class="nn">cloudpickle</span> <span class="kn">import</span> <span class="n">dumps</span> <span class="k">as</span> <span class="n">save_pickle_string</span><span class="p">,</span> <span class="n">loads</span> <span class="k">as</span> <span class="n">load_pickle_string</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">h5py</span> <span class="kn">import</span> <span class="n">File</span> <span class="k">as</span> <span class="n">h5_file</span>
<span class="kn">from</span> <span class="nn">py4j.java_gateway</span> <span class="kn">import</span> <span class="n">java_import</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">signature</span> <span class="k">as</span> <span class="n">get_model_params</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">from</span> <span class="nn">..spark.context</span> <span class="kn">import</span> <span class="n">PySpliceContext</span>

<span class="kn">from</span> <span class="nn">pyspark.ml.base</span> <span class="kn">import</span> <span class="n">Model</span> <span class="k">as</span> <span class="n">SparkModel</span>
<span class="kn">from</span> <span class="nn">pyspark.ml.feature</span> <span class="kn">import</span> <span class="n">IndexToString</span>
<span class="kn">from</span> <span class="nn">pyspark.ml.wrapper</span> <span class="kn">import</span> <span class="n">JavaModel</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">StructType</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.dataframe</span> <span class="kn">import</span> <span class="n">DataFrame</span> <span class="k">as</span> <span class="n">SparkDF</span>
<span class="kn">from</span> <span class="nn">pandas.core.frame</span> <span class="kn">import</span> <span class="n">DataFrame</span> <span class="k">as</span> <span class="n">PandasDF</span>

<span class="kn">from</span> <span class="nn">splicemachine.spark.constants</span> <span class="kn">import</span> <span class="n">SQL_TYPES</span>
<span class="kn">from</span> <span class="nn">splicemachine.mlflow_support.constants</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">mleap.pyspark.spark_support</span> <span class="kn">import</span> <span class="n">SimpleSparkSerializer</span>
<span class="kn">from</span> <span class="nn">mleap.version</span> <span class="kn">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">MLEAP_VERSION</span>

<span class="kn">import</span> <span class="nn">sklearn.base</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">sklearn_version</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">SKPipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.base</span> <span class="kn">import</span> <span class="n">BaseEstimator</span> <span class="k">as</span> <span class="n">ScikitModel</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">load_model</span> <span class="k">as</span> <span class="n">load_kr_model</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">Model</span> <span class="k">as</span> <span class="n">KerasModel</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">KERAS_VERSION</span>

<span class="kn">import</span> <span class="nn">h2o</span>
<span class="kn">from</span> <span class="nn">h2o.estimators.estimator_base</span> <span class="kn">import</span> <span class="n">ModelBase</span> <span class="k">as</span> <span class="n">H2OModel</span>
<span class="kn">from</span> <span class="nn">pyspark.ml.pipeline</span> <span class="kn">import</span> <span class="n">PipelineModel</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span>

<div class="viewcode-block" id="SpliceMachineException"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.SpliceMachineException">[docs]</a><span class="k">class</span> <span class="nc">SpliceMachineException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="SQL"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.SQL">[docs]</a><span class="k">class</span> <span class="nc">SQL</span><span class="p">:</span>
    <span class="n">MLMANAGER_SCHEMA</span> <span class="o">=</span> <span class="s1">&#39;MLMANAGER&#39;</span>
    <span class="n">ARTIFACT_INSERT_SQL</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;INSERT INTO </span><span class="si">{</span><span class="n">MLMANAGER_SCHEMA</span><span class="si">}</span><span class="s1">.ARTIFACTS (run_uuid, name, &quot;size&quot;, &quot;binary&quot;, file_extension) VALUES (?, ?, ?, ?, ?)&#39;</span>
    <span class="n">ARTIFACT_RETRIEVAL_SQL</span> <span class="o">=</span> <span class="s1">&#39;SELECT &quot;binary&quot;, file_extension FROM &#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">MLMANAGER_SCHEMA</span><span class="si">}</span><span class="s1">.&#39;</span> <span class="o">+</span> <span class="s1">&#39;ARTIFACTS WHERE name=</span><span class="se">\&#39;</span><span class="si">{name}</span><span class="se">\&#39;</span><span class="s1"> &#39;</span> \
                                                                                                <span class="s1">&#39;AND run_uuid=</span><span class="se">\&#39;</span><span class="si">{runid}</span><span class="se">\&#39;</span><span class="s1">&#39;</span>
    <span class="n">MODEL_INSERT_SQL</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;INSERT INTO </span><span class="si">{</span><span class="n">MLMANAGER_SCHEMA</span><span class="si">}</span><span class="s1">.MODELS(RUN_UUID, MODEL, LIBRARY, &quot;version&quot;) VALUES (?, ?, ?, ?)&#39;</span>
    <span class="n">MODEL_RETRIEVAL_SQL</span> <span class="o">=</span> <span class="s1">&#39;SELECT MODEL FROM </span><span class="si">{MLMANAGER_SCHEMA}</span><span class="s1">.MODELS WHERE RUN_UUID=</span><span class="se">\&#39;</span><span class="si">{run_uuid}</span><span class="se">\&#39;</span><span class="s1">&#39;</span></div>


<div class="viewcode-block" id="H2OUtils"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.H2OUtils">[docs]</a><span class="k">class</span> <span class="nc">H2OUtils</span><span class="p">:</span>
<div class="viewcode-block" id="H2OUtils.prep_model_for_deployment"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.H2OUtils.prep_model_for_deployment">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">prep_model_for_deployment</span><span class="p">(</span><span class="n">splice_context</span><span class="p">:</span> <span class="n">PySpliceContext</span><span class="p">,</span>
                                  <span class="n">model</span><span class="p">:</span> <span class="n">H2OModel</span><span class="p">,</span>
                                  <span class="n">classes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                                  <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                  <span class="n">df</span><span class="p">:</span> <span class="n">SparkDF</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
                                  <span class="n">pred_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
                                  <span class="n">sklearn_args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">H2OModelType</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the H2O mojo model</span>
<span class="sd">        Gets the model type</span>
<span class="sd">        Inserts the raw model into the MODELS table</span>
<span class="sd">        gets the classes (if applicable)</span>
<span class="sd">        returns the model type and classes</span>
<span class="sd">        :param splice_context:</span>
<span class="sd">        :param model:</span>
<span class="sd">        :param classes:</span>
<span class="sd">        :param run_id:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get the H2O MOJO model and insert it into the MODELS table</span>
        <span class="n">h2omojo</span><span class="p">,</span> <span class="n">rawmojo</span> <span class="o">=</span> <span class="n">H2OUtils</span><span class="o">.</span><span class="n">get_h2omojo_model</span><span class="p">(</span><span class="n">splice_context</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
        <span class="n">model_already_exists</span> <span class="o">=</span> <span class="n">H2OUtils</span><span class="o">.</span><span class="n">insert_h2omojo_model</span><span class="p">(</span><span class="n">splice_context</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">h2omojo</span><span class="p">)</span>

        <span class="c1"># Get model type</span>
        <span class="n">model_type</span><span class="p">,</span> <span class="n">model_category</span> <span class="o">=</span> <span class="n">H2OUtils</span><span class="o">.</span><span class="n">get_model_type</span><span class="p">(</span><span class="n">h2omojo</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">classes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">H2OModelType</span><span class="o">.</span><span class="n">KEY_VALUE</span><span class="p">,</span> <span class="n">H2OModelType</span><span class="o">.</span><span class="n">CLASSIFICATION</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Prediction labels found but model type does not support classes. Removing labels&#39;</span><span class="p">)</span>
                <span class="n">classes</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># handling spaces in class names</span>
                <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Prediction labels found. &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;Using </span><span class="si">{</span><span class="n">classes</span><span class="si">}</span><span class="s1"> as labels for predictions </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">)))</span><span class="si">}</span><span class="s1"> respectively&#39;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="n">H2OModelType</span><span class="o">.</span><span class="n">CLASSIFICATION</span><span class="p">:</span>
                <span class="c1"># Add a column for each class of the prediction to output the probability of the prediction</span>
                <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;p</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">rawmojo</span><span class="o">.</span><span class="n">getDomainValues</span><span class="p">(</span><span class="n">rawmojo</span><span class="o">.</span><span class="n">getResponseIdx</span><span class="p">()))]</span>
            <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="n">H2OModelType</span><span class="o">.</span><span class="n">KEY_VALUE</span><span class="p">:</span>
                <span class="c1"># These types have defined outputs, and we can preformat the column names</span>
                <span class="k">if</span> <span class="n">model_category</span> <span class="o">==</span> <span class="s1">&#39;AutoEncoder&#39;</span><span class="p">:</span>  <span class="c1"># The input columns are the output columns (reconstruction)</span>
                    <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_reconstr&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">rawmojo</span><span class="o">.</span><span class="n">getNames</span><span class="p">())]</span>
                    <span class="k">if</span> <span class="s1">&#39;DeeplearningMojoModel&#39;</span> <span class="ow">in</span> <span class="n">rawmojo</span><span class="o">.</span><span class="n">getClass</span><span class="p">()</span><span class="o">.</span><span class="n">toString</span><span class="p">():</span>  <span class="c1"># This class of autoencoder returns an MSE as well</span>
                        <span class="n">classes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;MSE&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">model_category</span> <span class="o">==</span> <span class="s1">&#39;TargetEncoder&#39;</span><span class="p">:</span>
                    <span class="n">classes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rawmojo</span><span class="o">.</span><span class="n">getNames</span><span class="p">())</span>
                    <span class="n">classes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">rawmojo</span><span class="o">.</span><span class="n">getResponseName</span><span class="p">())</span>  <span class="c1"># This is the label we are training on</span>
                    <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_te&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">model_category</span> <span class="o">==</span> <span class="s1">&#39;DimReduction&#39;</span><span class="p">:</span>
                    <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PC</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">k</span><span class="p">)]</span>
                <span class="k">elif</span> <span class="n">model_category</span> <span class="o">==</span> <span class="s1">&#39;WordEmbedding&#39;</span><span class="p">:</span>  <span class="c1"># We create a nXm columns</span>
                    <span class="c1"># n = vector dimension, m = number of word inputs</span>
                    <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">_C</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rawmojo</span><span class="o">.</span><span class="n">getVecSize</span><span class="p">())</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">rawmojo</span><span class="o">.</span><span class="n">getNames</span><span class="p">()]</span>
                <span class="k">elif</span> <span class="n">model_category</span> <span class="o">==</span> <span class="s1">&#39;AnomalyDetection&#39;</span><span class="p">:</span>
                    <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">,</span> <span class="s1">&#39;normalizedScore&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">model_already_exists</span></div>

<div class="viewcode-block" id="H2OUtils.get_model_type"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.H2OUtils.get_model_type">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_model_type</span><span class="p">(</span><span class="n">h2omojo</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">H2OModelType</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">cat</span> <span class="o">=</span> <span class="n">h2omojo</span><span class="o">.</span><span class="n">getModelCategory</span><span class="p">()</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cat</span> <span class="o">==</span> <span class="s1">&#39;Regression&#39;</span><span class="p">:</span>
            <span class="n">model_type</span> <span class="o">=</span> <span class="n">H2OModelType</span><span class="o">.</span><span class="n">REGRESSION</span>
        <span class="k">elif</span> <span class="n">cat</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;HGLMRegression&#39;</span><span class="p">,</span> <span class="s1">&#39;Clustering&#39;</span><span class="p">):</span>
            <span class="n">model_type</span> <span class="o">=</span> <span class="n">H2OModelType</span><span class="o">.</span><span class="n">SINGULAR</span>
        <span class="k">elif</span> <span class="n">cat</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Binomial&#39;</span><span class="p">,</span> <span class="s1">&#39;Multinomial&#39;</span><span class="p">,</span> <span class="s1">&#39;Ordinal&#39;</span><span class="p">):</span>
            <span class="n">model_type</span> <span class="o">=</span> <span class="n">H2OModelType</span><span class="o">.</span><span class="n">CLASSIFICATION</span>
        <span class="k">elif</span> <span class="n">cat</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;AutoEncoder&#39;</span><span class="p">,</span> <span class="s1">&#39;TargetEncoder&#39;</span><span class="p">,</span> <span class="s1">&#39;DimReduction&#39;</span><span class="p">,</span> <span class="s1">&#39;WordEmbedding&#39;</span><span class="p">,</span> <span class="s1">&#39;AnomalyDetection&#39;</span><span class="p">):</span>
            <span class="n">model_type</span> <span class="o">=</span> <span class="n">H2OModelType</span><span class="o">.</span><span class="n">KEY_VALUE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SpliceMachineException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;H2O model </span><span class="si">{</span><span class="n">cat</span><span class="si">}</span><span class="s2"> is not supported! Only models with MOJOs are currently supported.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">cat</span></div>

<div class="viewcode-block" id="H2OUtils.get_h2omojo_model"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.H2OUtils.get_h2omojo_model">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_h2omojo_model</span><span class="p">(</span><span class="n">splice_context</span><span class="p">:</span> <span class="n">PySpliceContext</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">H2OModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="nb">object</span><span class="p">):</span>
        <span class="n">jvm</span> <span class="o">=</span> <span class="n">splice_context</span><span class="o">.</span><span class="n">jvm</span>
        <span class="n">java_import</span><span class="p">(</span><span class="n">jvm</span><span class="p">,</span> <span class="s2">&quot;java.io.{BinaryOutputStream, ObjectOutputStream, ByteArrayInputStream}&quot;</span><span class="p">)</span>
        <span class="n">java_import</span><span class="p">(</span><span class="n">jvm</span><span class="p">,</span> <span class="s1">&#39;hex.genmodel.easy.EasyPredictModelWrapper&#39;</span><span class="p">)</span>
        <span class="n">java_import</span><span class="p">(</span><span class="n">jvm</span><span class="p">,</span> <span class="s1">&#39;hex.genmodel.MojoModel&#39;</span><span class="p">)</span>
        <span class="n">model_path</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">download_mojo</span><span class="p">(</span><span class="s1">&#39;/tmp/model.zip&#39;</span><span class="p">)</span>
        <span class="n">raw_mojo</span> <span class="o">=</span> <span class="n">jvm</span><span class="o">.</span><span class="n">MojoModel</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
        <span class="n">java_mojo_c</span> <span class="o">=</span> <span class="n">jvm</span><span class="o">.</span><span class="n">EasyPredictModelWrapper</span><span class="o">.</span><span class="n">Config</span><span class="p">()</span><span class="o">.</span><span class="n">setModel</span><span class="p">(</span><span class="n">raw_mojo</span><span class="p">)</span>
        <span class="n">java_mojo</span> <span class="o">=</span> <span class="n">jvm</span><span class="o">.</span><span class="n">EasyPredictModelWrapper</span><span class="p">(</span><span class="n">java_mojo_c</span><span class="p">)</span>
        <span class="n">remove</span><span class="p">(</span><span class="s1">&#39;/tmp/model.zip&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">java_mojo</span><span class="p">,</span> <span class="n">raw_mojo</span></div>

<div class="viewcode-block" id="H2OUtils.log_h2o_model"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.H2OUtils.log_h2o_model">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">log_h2o_model</span><span class="p">(</span><span class="n">splice_context</span><span class="p">:</span> <span class="n">PySpliceContext</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model_path</span> <span class="o">=</span> <span class="n">h2o</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;/tmp/model&#39;</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">artifact</span><span class="p">:</span>
            <span class="n">byte_stream</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">artifact</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>
        <span class="n">insert_artifact</span><span class="p">(</span><span class="n">splice_context</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">byte_stream</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">file_ext</span><span class="o">=</span><span class="n">FileExtensions</span><span class="o">.</span><span class="n">h2o</span><span class="p">)</span>
        <span class="n">rmtree</span><span class="p">(</span><span class="s1">&#39;/tmp/model&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="H2OUtils.load_h2o_model"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.H2OUtils.load_h2o_model">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">load_h2o_model</span><span class="p">(</span><span class="n">model_blob</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">H2OModel</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/tmp/model&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">model_blob</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">h2o</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="s1">&#39;/tmp/model&#39;</span><span class="p">)</span>
        <span class="n">remove</span><span class="p">(</span><span class="s1">&#39;/tmp/model&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span></div>

<div class="viewcode-block" id="H2OUtils.insert_h2omojo_model"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.H2OUtils.insert_h2omojo_model">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">insert_h2omojo_model</span><span class="p">(</span><span class="n">splice_context</span><span class="p">:</span> <span class="n">PySpliceContext</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">baos</span> <span class="o">=</span> <span class="n">splice_context</span><span class="o">.</span><span class="n">jvm</span><span class="o">.</span><span class="n">java</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">ByteArrayOutputStream</span><span class="p">()</span>
        <span class="n">oos</span> <span class="o">=</span> <span class="n">splice_context</span><span class="o">.</span><span class="n">jvm</span><span class="o">.</span><span class="n">java</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">ObjectOutputStream</span><span class="p">(</span><span class="n">baos</span><span class="p">)</span>
        <span class="n">oos</span><span class="o">.</span><span class="n">writeObject</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">oos</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">oos</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">byte_array</span> <span class="o">=</span> <span class="n">baos</span><span class="o">.</span><span class="n">toByteArray</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">insert_model</span><span class="p">(</span><span class="n">splice_context</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">byte_array</span><span class="p">,</span> <span class="s1">&#39;h2omojo&#39;</span><span class="p">,</span> <span class="n">h2o</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="SKUtils"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.SKUtils">[docs]</a><span class="k">class</span> <span class="nc">SKUtils</span><span class="p">:</span>
<div class="viewcode-block" id="SKUtils.log_sklearn_model"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.SKUtils.log_sklearn_model">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">log_sklearn_model</span><span class="p">(</span><span class="n">splice_context</span><span class="p">:</span> <span class="n">PySpliceContext</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">ScikitModel</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">byte_stream</span> <span class="o">=</span> <span class="n">save_pickle_string</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">insert_artifact</span><span class="p">(</span><span class="n">splice_context</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">byte_stream</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">file_ext</span><span class="o">=</span><span class="n">FileExtensions</span><span class="o">.</span><span class="n">sklearn</span><span class="p">)</span></div>

<div class="viewcode-block" id="SKUtils.load_sklearn_model"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.SKUtils.load_sklearn_model">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">load_sklearn_model</span><span class="p">(</span><span class="n">model_blob</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">load_pickle_string</span><span class="p">(</span><span class="n">model_blob</span><span class="p">)</span></div>

<div class="viewcode-block" id="SKUtils.insert_sklearn_model"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.SKUtils.insert_sklearn_model">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">insert_sklearn_model</span><span class="p">(</span><span class="n">splice_context</span><span class="p">:</span> <span class="n">PySpliceContext</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">ScikitModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">byte_stream</span> <span class="o">=</span> <span class="n">save_pickle_string</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">insert_model</span><span class="p">(</span><span class="n">splice_context</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">byte_stream</span><span class="p">,</span> <span class="s1">&#39;sklearn&#39;</span><span class="p">,</span> <span class="n">sklearn_version</span><span class="p">)</span></div>

<div class="viewcode-block" id="SKUtils.validate_sklearn_args"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.SKUtils.validate_sklearn_args">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">validate_sklearn_args</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">ScikitModel</span><span class="p">,</span> <span class="n">sklearn_args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make sure sklearn args contains valid values. sklearn_args can only contain 2 keys:</span>
<span class="sd">        predict_call and predict_args.</span>
<span class="sd">        predict_call: &#39;predict&#39;/&#39;predict_proba&#39;/&#39;transform&#39;</span>
<span class="sd">        predict_args: &#39;return_std&#39;/&#39;return_cov&#39;</span>

<span class="sd">        :param model: (ScikitModel)</span>
<span class="sd">        :param sklearn_args: (Dict[str, str])</span>
<span class="sd">        :return: (Dict[str, str]) sklearn_args</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">sklearn_args</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">keys</span> <span class="o">-</span> <span class="p">{</span><span class="s1">&#39;predict_call&#39;</span><span class="p">,</span> <span class="s1">&#39;predict_args&#39;</span><span class="p">}</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">():</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="s2">&quot;You&#39;ve passed in an sklearn_args key that is not valid. Valid keys are (&#39;predict_call&#39;, &#39;predict_args&#39;)&quot;</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">sklearn_args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">exc</span> <span class="o">=</span><span class="s1">&#39;Only predict_call and predict_args are allowed in sklearn_args!&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;predict_call&#39;</span> <span class="ow">in</span> <span class="n">sklearn_args</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">sklearn_args</span><span class="p">[</span><span class="s1">&#39;predict_call&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
                <span class="n">exc</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;predict_call set to </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1"> but function call not available in model </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">!=</span> <span class="s1">&#39;predict&#39;</span> <span class="ow">and</span> <span class="s1">&#39;predict_args&#39;</span> <span class="ow">in</span> <span class="n">sklearn_args</span><span class="p">:</span>
                <span class="n">exc</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;predict_args passed in but predict_call is </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">. This combination is not allowed&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;predict_args&#39;</span> <span class="ow">in</span> <span class="n">sklearn_args</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">sklearn_args</span><span class="p">[</span><span class="s1">&#39;predict_args&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;return_std&#39;</span><span class="p">,</span> <span class="s1">&#39;return_cov&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">SKPipeline</span><span class="p">):</span> <span class="c1"># Pipelines have difference rules for params</span>
                <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;return_std&#39;</span><span class="p">,</span> <span class="s1">&#39;return_cov&#39;</span><span class="p">)</span>
                <span class="n">exc</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;predict_args value is invalid. Available options are </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">SKPipeline</span><span class="p">):</span> <span class="c1"># If we are working with a Pipeline, we want to check the last step for arguments</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">model_params</span> <span class="o">=</span> <span class="n">get_model_params</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">predict</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;predict&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">get_model_params</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">transform</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">model_params</span> <span class="o">=</span> <span class="n">get_model_params</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;predict&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">get_model_params</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">transform</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model_params</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
                    <span class="n">exc</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;predict_args set to </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1"> but that parameter is not available for this model!&#39;</span>
        <span class="k">elif</span> <span class="n">sklearn_args</span> <span class="ow">and</span> <span class="s1">&#39;predict_args&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sklearn_args</span> <span class="ow">and</span> <span class="s1">&#39;predict_call&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sklearn_args</span><span class="p">:</span>
                <span class="n">exc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;predict_args contains invalid arguments. Valid arguments are &#39;predict_call&#39; and &#39;predict_args&#39;&quot;</span>
        <span class="k">if</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SpliceMachineException</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sklearn_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;predict_call&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;predict&#39;</span> <span class="ow">and</span> <span class="s1">&#39;predict_args&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sklearn_args</span><span class="p">:</span>
            <span class="c1"># If the user only passed in predict, then sklearn args is effectively empty</span>
            <span class="n">sklearn_args</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">sklearn_args</span></div>

<div class="viewcode-block" id="SKUtils.prep_model_for_deployment"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.SKUtils.prep_model_for_deployment">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">prep_model_for_deployment</span><span class="p">(</span><span class="n">splice_context</span><span class="p">:</span> <span class="n">PySpliceContext</span><span class="p">,</span>
                                  <span class="n">model</span><span class="p">:</span> <span class="n">ScikitModel</span><span class="p">,</span>
                                  <span class="n">classes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                                  <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                  <span class="n">df</span><span class="p">:</span> <span class="n">SparkDF</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
                                  <span class="n">pred_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
                                  <span class="n">sklearn_args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">SklearnModelType</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Preperatory steps to deploy a scikit-learn model</span>

<span class="sd">        :param splice_context: (PySpliceContext)</span>
<span class="sd">        :param model: (ScikitModel)</span>
<span class="sd">        :param classes: (List[str]) The label names for the model</span>
<span class="sd">        :param run_id: (str) the run_id being deployed under</span>
<span class="sd">        :param df: (SparkDF or None) the spark dataframe if necessary</span>
<span class="sd">        :param pred_threshold: (None) unused in this abstract method implementation</span>
<span class="sd">        :param sklearn_args: (Dict[str,str]) The optional sklearn args</span>
<span class="sd">        :return: (SklearnModelType, List[str], bool) the model_type, classes, and model_already_exists</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sklearn_args</span> <span class="o">=</span> <span class="n">SKUtils</span><span class="o">.</span><span class="n">validate_sklearn_args</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">sklearn_args</span><span class="p">)</span>

        <span class="n">model_type</span> <span class="o">=</span> <span class="n">SKUtils</span><span class="o">.</span><span class="n">get_model_type</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">sklearn_args</span><span class="p">)</span>
        <span class="n">model_already_exists</span> <span class="o">=</span> <span class="n">SKUtils</span><span class="o">.</span><span class="n">insert_sklearn_model</span><span class="p">(</span><span class="n">splice_context</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">classes</span> <span class="ow">and</span> <span class="n">model_type</span> <span class="o">!=</span> <span class="n">SklearnModelType</span><span class="o">.</span><span class="n">KEY_VALUE</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Prediction labels found but model is not type Classification. Removing labels&#39;</span><span class="p">)</span>
            <span class="n">classes</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">elif</span> <span class="n">classes</span><span class="p">:</span>
            <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="n">SklearnModelType</span><span class="o">.</span><span class="n">KEY_VALUE</span><span class="p">:</span>
            <span class="c1"># For models that have both predict and transform functions (like LDA)</span>
            <span class="k">if</span> <span class="n">sklearn_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;predict_call&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;transform&#39;</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;transform&#39;</span><span class="p">):</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_params</span><span class="p">()</span>
                <span class="n">nclasses</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;n_clusters&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;n_components&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">2</span>
                <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;C</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nclasses</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="s1">&#39;predict_args&#39;</span> <span class="ow">in</span> <span class="n">sklearn_args</span><span class="p">:</span>
                <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">,</span> <span class="n">sklearn_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;predict_args&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;return_&#39;</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;classes_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">model</span><span class="o">.</span><span class="n">classes_</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;C</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">classes_</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;get_params&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="s1">&#39;n_components&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="s1">&#39;n_components&#39;</span><span class="p">)</span> <span class="p">):</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_params</span><span class="p">()</span>
                <span class="n">nclasses</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;n_clusters&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;n_components&#39;</span><span class="p">)</span>
                <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;C</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nclasses</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SpliceMachineException</span><span class="p">(</span><span class="s1">&#39;Could not find class labels from model. Please pass in class labels using&#39;</span>
                                             <span class="s1">&#39;the classes parameter.&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">sklearn_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;predict_call&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;predict_proba&#39;</span><span class="p">:</span> <span class="c1"># We need to add a column for the actual prediction</span>
                <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">classes</span>
        <span class="k">if</span> <span class="n">classes</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Prediction labels found. Using </span><span class="si">{</span><span class="n">classes</span><span class="si">}</span><span class="s1"> as labels for predictions </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">)))</span><span class="si">}</span><span class="s1"> respectively&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">model_already_exists</span></div>

<div class="viewcode-block" id="SKUtils.get_pipeline_model_type"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.SKUtils.get_pipeline_model_type">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_pipeline_model_type</span><span class="p">(</span><span class="n">pipeline</span><span class="p">:</span> <span class="n">SKPipeline</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SklearnModelType</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the type of model in the Sklearn Pipeline</span>

<span class="sd">        :param pipeline: The Sklearn Pipeline</span>
<span class="sd">        :return: SKlearnModelType</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">steps</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="c1"># Go through steps backwards because model likely last step</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="p">(</span><span class="n">sklearn</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">ClusterMixin</span><span class="p">,</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">ClassifierMixin</span><span class="p">)):</span>
                <span class="n">model_type</span> <span class="o">=</span> <span class="n">SklearnModelType</span><span class="o">.</span><span class="n">POINT_PREDICTION_CLF</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">RegressorMixin</span><span class="p">):</span>
                <span class="n">model_type</span> <span class="o">=</span> <span class="n">SklearnModelType</span><span class="o">.</span><span class="n">REGRESSION</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model_type</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SpliceMachineException</span><span class="p">(</span><span class="s1">&#39;Could not determine the type of Pipeline! Model stage is not of &#39;</span>
                                             <span class="s1">&#39;classification, regression or clustering.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model_type</span></div>
            

<div class="viewcode-block" id="SKUtils.get_model_type"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.SKUtils.get_model_type">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_model_type</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">ScikitModel</span><span class="p">,</span> <span class="n">sklearn_args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">SklearnModelType</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the model type of the Scikit-learn model</span>

<span class="sd">        :param model: (ScikitModel)</span>
<span class="sd">        :param sklearn_args: (Dict[str,str]) the optional scikit-learn args</span>
<span class="sd">        :return: SklearnModelType</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># sklearn_args will affect the output type</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sklearn_args</span><span class="p">:</span>
            <span class="c1"># Either predict or transform here</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;predict&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">SKPipeline</span><span class="p">):</span>
                    <span class="n">model_type</span> <span class="o">=</span> <span class="n">SKUtils</span><span class="o">.</span><span class="n">get_pipeline_model_type</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">RegressorMixin</span><span class="p">):</span>
                    <span class="n">model_type</span> <span class="o">=</span> <span class="n">SklearnModelType</span><span class="o">.</span><span class="n">REGRESSION</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="p">(</span><span class="n">sklearn</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">ClusterMixin</span><span class="p">,</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">ClassifierMixin</span><span class="p">)):</span>
                    <span class="n">model_type</span> <span class="o">=</span> <span class="n">SklearnModelType</span><span class="o">.</span><span class="n">POINT_PREDICTION_CLF</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">SpliceMachineException</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown Sklearn Model Type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;transform&#39;</span><span class="p">):</span> <span class="c1"># Transform functions create more than a single point prediction</span>
                <span class="n">model_type</span> <span class="o">=</span> <span class="n">SklearnModelType</span><span class="o">.</span><span class="n">KEY_VALUE</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SpliceMachineException</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Model </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="si">}</span><span class="s1"> does not have predict or transform function!&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># If sklearn_args have been passed in, the model must be returning multiple key values</span>
            <span class="n">model_type</span> <span class="o">=</span> <span class="n">SklearnModelType</span><span class="o">.</span><span class="n">KEY_VALUE</span>
        <span class="k">return</span> <span class="n">model_type</span></div></div>


<div class="viewcode-block" id="KerasUtils"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.KerasUtils">[docs]</a><span class="k">class</span> <span class="nc">KerasUtils</span><span class="p">:</span>
<div class="viewcode-block" id="KerasUtils.log_keras_model"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.KerasUtils.log_keras_model">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">log_keras_model</span><span class="p">(</span><span class="n">splice_context</span><span class="p">:</span> <span class="n">PySpliceContext</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">KerasModel</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Logs the Keras Model in the MLManager Aritfacts table</span>

<span class="sd">        :param splice_context: (PySpliceContext)</span>
<span class="sd">        :param model: (KerasModel)</span>
<span class="sd">        :param name: (str) The name to give the model</span>
<span class="sd">        :param run_id: (str) The mlflow run id</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;/tmp/model.h5&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/tmp/model.h5&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">byte_stream</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>
        <span class="n">insert_artifact</span><span class="p">(</span><span class="n">splice_context</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">byte_stream</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">file_ext</span><span class="o">=</span><span class="n">FileExtensions</span><span class="o">.</span><span class="n">keras</span><span class="p">)</span>
        <span class="n">remove</span><span class="p">(</span><span class="s1">&#39;/tmp/model.h5&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="KerasUtils.load_keras_model"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.KerasUtils.load_keras_model">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">load_keras_model</span><span class="p">(</span><span class="n">model_blob</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KerasModel</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deserializes the serialized Keras Model blob</span>

<span class="sd">        :param model_blob: (object) the model blob</span>
<span class="sd">        :return: KerasModel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hfile</span> <span class="o">=</span> <span class="n">h5_file</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">model_blob</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">load_kr_model</span><span class="p">(</span><span class="n">hfile</span><span class="p">)</span></div>

<div class="viewcode-block" id="KerasUtils.insert_keras_model"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.KerasUtils.insert_keras_model">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">insert_keras_model</span><span class="p">(</span><span class="n">splice_context</span><span class="p">:</span> <span class="n">PySpliceContext</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">KerasModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inserts the Keras Model into the MLManager Models table for deployment</span>

<span class="sd">        :param splice_context:</span>
<span class="sd">        :param run_id:</span>
<span class="sd">        :param model:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;/tmp/model.h5&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/tmp/model.h5&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">byte_stream</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>
        <span class="n">remove</span><span class="p">(</span><span class="s1">&#39;/tmp/model.h5&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">insert_model</span><span class="p">(</span><span class="n">splice_context</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">byte_stream</span><span class="p">,</span> <span class="s1">&#39;keras&#39;</span><span class="p">,</span> <span class="n">KERAS_VERSION</span><span class="p">)</span></div>

<div class="viewcode-block" id="KerasUtils.get_keras_model_type"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.KerasUtils.get_keras_model_type">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_keras_model_type</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">KerasModel</span><span class="p">,</span> <span class="n">pred_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KerasModelType</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Keras models are either Key value returns or &quot;regression&quot; (single value)</span>
<span class="sd">        If the output layer has multiple nodes, or there is a threshold (for binary classification), it will</span>
<span class="sd">        be a key value return because n values will be returned (n = # output nodes + 1)</span>
<span class="sd">        :param model: (KerasModel)</span>
<span class="sd">        :param pred_threshold: (float) the prediction threshold if one is passed</span>
<span class="sd">        :return: (KerasModelType)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">pred_threshold</span><span class="p">:</span>
            <span class="n">model_type</span> <span class="o">=</span> <span class="n">KerasModelType</span><span class="o">.</span><span class="n">KEY_VALUE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model_type</span> <span class="o">=</span> <span class="n">KerasModelType</span><span class="o">.</span><span class="n">REGRESSION</span>
        <span class="k">return</span> <span class="n">model_type</span></div>

<div class="viewcode-block" id="KerasUtils.validate_keras_model"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.KerasUtils.validate_keras_model">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">validate_keras_model</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">KerasModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Right now, we only support feed forward models. Vector inputs and Vector outputs only</span>
<span class="sd">        When we move to LSTMs we will need to change that</span>
<span class="sd">        :param model:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">input_shape</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">input_shape</span>
        <span class="n">output_shape</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output_shape</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">input_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">output_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">SpliceMachineException</span><span class="p">(</span><span class="s2">&quot;We currently only support feed-forward models. The input and output shapes&quot;</span>
                                         <span class="s2">&quot;of the models must be (None, #). Please raise an issue here: https://github.com/splicemachine/pysplice/issues&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="KerasUtils.prep_model_for_deployment"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.KerasUtils.prep_model_for_deployment">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">prep_model_for_deployment</span><span class="p">(</span><span class="n">splice_context</span><span class="p">:</span> <span class="n">PySpliceContext</span><span class="p">,</span>
                                  <span class="n">model</span><span class="p">:</span> <span class="n">KerasModel</span><span class="p">,</span>
                                  <span class="n">classes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                                  <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                  <span class="n">df</span><span class="p">:</span> <span class="n">SparkDF</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
                                  <span class="n">pred_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
                                  <span class="n">sklearn_args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">)</span><span class="o">-&gt;</span> <span class="p">(</span><span class="n">KerasModelType</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inserts the model into the MODELS table for deployment</span>
<span class="sd">        Gets the Keras model type</span>
<span class="sd">        Gets the classes (if applicable)</span>
<span class="sd">        :param splice_context: PySpliceContext</span>
<span class="sd">        :param model: KerasModel</span>
<span class="sd">        :param classes: List[str] the class labels</span>
<span class="sd">        :param run_id: str</span>
<span class="sd">        :param pred_threshold: double</span>
<span class="sd">        :return: (KerasModelType, List[str]) the modelType and the classes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">KerasUtils</span><span class="o">.</span><span class="n">validate_keras_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">model_already_exists</span> <span class="o">=</span> <span class="n">KerasUtils</span><span class="o">.</span><span class="n">insert_keras_model</span><span class="p">(</span><span class="n">splice_context</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
        <span class="n">model_type</span><span class="p">:</span> <span class="n">KerasModelType</span> <span class="o">=</span> <span class="n">KerasUtils</span><span class="o">.</span><span class="n">get_keras_model_type</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">pred_threshold</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="n">KerasModelType</span><span class="o">.</span><span class="n">KEY_VALUE</span><span class="p">:</span>
            <span class="n">output_shape</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output_shape</span>
            <span class="k">if</span> <span class="n">classes</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span> <span class="o">!=</span> <span class="n">output_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">SpliceMachineException</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The number of classes, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span><span class="si">}</span><span class="s1">, does not match &#39;</span>
                                             <span class="sa">f</span><span class="s1">&#39;the output shape of your model, </span><span class="si">{</span><span class="n">output_shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">classes</span><span class="p">:</span>
                <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;output</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">output_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">classes</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">pred_threshold</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found multiclass model with pred_threshold </span><span class="si">{</span><span class="n">pred_threshold</span><span class="si">}</span><span class="s2">. Ignoring threshold.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">model_already_exists</span></div></div>



<div class="viewcode-block" id="SparkUtils"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.SparkUtils">[docs]</a><span class="k">class</span> <span class="nc">SparkUtils</span><span class="p">:</span>
<div class="viewcode-block" id="SparkUtils.get_stages"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.SparkUtils.get_stages">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_stages</span><span class="p">(</span><span class="n">pipeline</span><span class="p">:</span> <span class="n">PipelineModel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract the stages from a fit or unfit pipeline</span>

<span class="sd">        :param pipeline: a fit or unfit Spark pipeline</span>
<span class="sd">        :return: stages list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="s1">&#39;getStages&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">getStages</span><span class="p">()</span>  <span class="c1"># unfit pipeline</span>
        <span class="k">return</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">stages</span>  <span class="c1"># fit pipeline</span></div>

<div class="viewcode-block" id="SparkUtils.get_cols"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.SparkUtils.get_cols">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_cols</span><span class="p">(</span><span class="n">transformer</span><span class="p">,</span> <span class="n">get_input</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get columns from a transformer</span>

<span class="sd">        :param transformer: the transformer (fit or unfit)</span>
<span class="sd">        :param get_input: whether or not to return the input columns</span>
<span class="sd">        :return: a list of either input or output columns</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">col_type</span> <span class="o">=</span> <span class="s1">&#39;Input&#39;</span> <span class="k">if</span> <span class="n">get_input</span> <span class="k">else</span> <span class="s1">&#39;Output&#39;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">transformer</span><span class="p">,</span> <span class="s1">&#39;get&#39;</span> <span class="o">+</span> <span class="n">col_type</span> <span class="o">+</span> <span class="s1">&#39;Col&#39;</span><span class="p">):</span>  <span class="c1"># single transformer 1:1 (regular)</span>
            <span class="n">col_function</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">getInputCol</span> <span class="k">if</span> <span class="n">get_input</span> <span class="k">else</span> <span class="n">transformer</span><span class="o">.</span><span class="n">getOutputCol</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="n">col_function</span><span class="p">()]</span> <span class="k">if</span> <span class="n">get_input</span> <span class="k">else</span> <span class="n">col_function</span><span class="p">()</span>  <span class="c1"># so we don&#39;t need to change code for</span>
            <span class="c1"># a single transformer</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">transformer</span><span class="p">,</span> <span class="n">col_type</span> <span class="o">+</span> <span class="s2">&quot;Col&quot;</span><span class="p">):</span>  <span class="c1"># single transformer 1:1 (vec)</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">transformer</span><span class="p">,</span> <span class="n">col_type</span> <span class="o">+</span> <span class="s2">&quot;Col&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">get_input</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">transformer</span><span class="p">,</span>
                                   <span class="s1">&#39;get&#39;</span> <span class="o">+</span> <span class="n">col_type</span> <span class="o">+</span> <span class="s1">&#39;Cols&#39;</span><span class="p">):</span>  <span class="c1"># multi ple transformer n:1 (regular)</span>
            <span class="k">return</span> <span class="n">transformer</span><span class="o">.</span><span class="n">getInputCols</span><span class="p">()</span>  <span class="c1"># we can never have &gt; 1 output column (goes to vector)</span>
        <span class="k">elif</span> <span class="n">get_input</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">transformer</span><span class="p">,</span> <span class="n">col_type</span> <span class="o">+</span> <span class="s1">&#39;Cols&#39;</span><span class="p">):</span>  <span class="c1"># multiple transformer n:1 (vec)</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">transformer</span><span class="p">,</span> <span class="n">col_type</span> <span class="o">+</span> <span class="s2">&quot;Cols&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Warning: Transformer &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                    <span class="n">transformer</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; could not be parsed. If this is a model, this is expected.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SparkUtils.readable_pipeline_stage"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.SparkUtils.readable_pipeline_stage">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">readable_pipeline_stage</span><span class="p">(</span><span class="n">pipeline_stage</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a readable version of the Pipeline stage (without the memory address)</span>

<span class="sd">        :param pipeline_stage: the name of the stage to parse</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;_&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">pipeline_stage</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">pipeline_stage</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">pipeline_stage</span><span class="p">)</span></div>

<div class="viewcode-block" id="SparkUtils.is_spark_pipeline"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.SparkUtils.is_spark_pipeline">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">is_spark_pipeline</span><span class="p">(</span><span class="n">spark_object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns whether or not the given object is a spark pipeline. If it is a Pipeline, it will return True, if it is a</span>
<span class="sd">        model is will return False. Otherwise, it will throw an exception</span>

<span class="sd">        :param spark_object: (Model) Spark object to check</span>
<span class="sd">        :return: (bool) whether or not the object is a model</span>
<span class="sd">        :exception: (SpliceMachineException) throws an error if it is not either</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spark_object</span><span class="p">,</span> <span class="n">PipelineModel</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spark_object</span><span class="p">,</span> <span class="n">SparkModel</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">raise</span> <span class="n">SpliceMachineException</span><span class="p">(</span><span class="s2">&quot;The model supplied does not appear to be a Spark Model!&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SparkUtils.get_model_stage"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.SparkUtils.get_model_stage">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_model_stage</span><span class="p">(</span><span class="n">pipeline</span><span class="p">:</span> <span class="n">PipelineModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SparkModel</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">        Gets the Model stage of a FIT PipelineModel</span>

<span class="sd">        :param pipeline: (PipelineModel)</span>
<span class="sd">        :return: SparkModel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">SparkUtils</span><span class="o">.</span><span class="n">get_stages</span><span class="p">(</span><span class="n">pipeline</span><span class="p">):</span>
            <span class="c1"># StandardScaler is also implemented as a base Model and JavaModel for some reason but that&#39;s not a model</span>
            <span class="c1"># So we need to make sure the stage isn&#39;t a feature</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">SparkModel</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">JavaModel</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;feature&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="vm">__module__</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">i</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Could not find model stage in Pipeline! Is this a fitted spark Pipeline?&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SparkUtils.try_get_class_labels"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.SparkUtils.try_get_class_labels">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">try_get_class_labels</span><span class="p">(</span><span class="n">pipeline</span><span class="p">:</span> <span class="n">PipelineModel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tries to get the class labels for a Spark Model. This will only work if the Pipeline has a Model and an IndexToString</span>
<span class="sd">        where the inputCol of the IndexToString is the same as the predictionCol of the Model</span>

<span class="sd">        :param pipeline: (PipelineModel) The fitted spark PipelineModel</span>
<span class="sd">        :return: List[str] the class labels in order of numeric value (0,1,2 etc)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="s1">&#39;getStages&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SpliceMachineException</span><span class="p">(</span><span class="s1">&#39;The passed in pipeline has not been fit. Please pass in a fit pipeline&#39;</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">SparkUtils</span><span class="o">.</span><span class="n">get_model_stage</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="n">SparkUtils</span><span class="o">.</span><span class="n">get_stages</span><span class="p">(</span><span class="n">pipeline</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span> <span class="n">IndexToString</span><span class="p">):</span>  <span class="c1"># It&#39;s an IndexToString</span>
                <span class="k">if</span> <span class="n">stage</span><span class="o">.</span><span class="n">getOrDefault</span><span class="p">(</span><span class="s1">&#39;inputCol&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">model</span><span class="o">.</span><span class="n">getOrDefault</span><span class="p">(</span>
                        <span class="s1">&#39;predictionCol&#39;</span><span class="p">):</span>  <span class="c1"># It&#39;s the correct IndexToString</span>
                    <span class="n">labels</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">getOrDefault</span><span class="p">(</span><span class="s1">&#39;labels&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">labels</span></div>

<div class="viewcode-block" id="SparkUtils.parse_string_parameters"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.SparkUtils.parse_string_parameters">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parse_string_parameters</span><span class="p">(</span><span class="n">string_parameters</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse string rendering of extractParamMap</span>

<span class="sd">        :param string_parameters: (str) the string parameters</span>
<span class="sd">        :return: Dict the parsed parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">parsed_mapping</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">string_parameters</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;}&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="n">parsed_mapping</span><span class="p">:</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="n">mapping</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="n">mapping</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">parameters</span><span class="p">[</span><span class="n">param</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">parameters</span></div>

<div class="viewcode-block" id="SparkUtils.retrieve_artifact_stream"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.SparkUtils.retrieve_artifact_stream">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">retrieve_artifact_stream</span><span class="p">(</span><span class="n">splice_context</span><span class="p">:</span> <span class="n">PySpliceContext</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the binary stream for a given artifact with the specified name and run id</span>

<span class="sd">        :param splice_context: (PySpliceContext) the PySpliceContext</span>
<span class="sd">        :param run_id: (str) the run id for the run that the artifact belongs to</span>
<span class="sd">        :param name: (str) the name of the artifact</span>
<span class="sd">        :return: (bytearray(byte)) byte array from BLOB</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">splice_context</span><span class="o">.</span><span class="n">df</span><span class="p">(</span>
                <span class="n">SQL</span><span class="o">.</span><span class="n">ARTIFACT_RETRIEVAL_SQL</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">runid</span><span class="o">=</span><span class="n">run_id</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to find the artifact with the given run id </span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="s2"> and name </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SparkUtils.get_feature_vector_columns"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.SparkUtils.get_feature_vector_columns">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_feature_vector_columns</span><span class="p">(</span><span class="n">fittedPipe</span><span class="p">:</span> <span class="n">PipelineModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the input columns from the VectorAssembler stage of a fitted Pipeline</span>

<span class="sd">        :param fittedPipe: (PipelineModel) The trained model</span>
<span class="sd">        :return: List[str] the feature vector columns</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vec_stage</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">fittedPipe</span><span class="o">.</span><span class="n">stages</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;VectorAssembler&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                <span class="n">vec_stage</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">SparkUtils</span><span class="o">.</span><span class="n">get_cols</span><span class="p">(</span><span class="n">vec_stage</span><span class="p">)</span></div>

<div class="viewcode-block" id="SparkUtils.get_num_classes"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.SparkUtils.get_num_classes">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_num_classes</span><span class="p">(</span><span class="n">pipeline_or_model</span><span class="p">:</span> <span class="n">SparkModel</span> <span class="ow">or</span> <span class="n">PipelineModel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tries to find the number of classes in a Pipeline or Model object</span>

<span class="sd">        :param pipeline_or_model: The Pipeline or Model object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;pipeline&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">pipeline_or_model</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">SparkUtils</span><span class="o">.</span><span class="n">get_model_stage</span><span class="p">(</span><span class="n">pipeline_or_model</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">pipeline_or_model</span>
        <span class="n">num_classes</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">numClasses</span> <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">hasParam</span><span class="p">(</span><span class="s1">&#39;numClasses&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">model</span><span class="o">.</span><span class="n">numClasses</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span>
                                                                                                        <span class="s1">&#39;numClasses&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">k</span>
        <span class="k">return</span> <span class="n">num_classes</span></div>

<div class="viewcode-block" id="SparkUtils.get_model_type"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.SparkUtils.get_model_type">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_model_type</span><span class="p">(</span><span class="n">pipeline_or_model</span><span class="p">:</span> <span class="n">SparkModel</span> <span class="ow">or</span> <span class="n">PipelineModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SparkModelType</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Takes a fitted Spark Pipeline or Model and determines if it is a Regression, Classification, or Clustering model</span>

<span class="sd">        :param pipeline_or_model: (SparkModel or PipelineModel) the fitted Spark model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">SparkUtils</span><span class="o">.</span><span class="n">get_model_stage</span><span class="p">(</span><span class="n">pipeline_or_model</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">==</span> <span class="s1">&#39;pyspark.ml.classification&#39;</span><span class="p">:</span>
            <span class="n">m_type</span> <span class="o">=</span> <span class="n">SparkModelType</span><span class="o">.</span><span class="n">CLASSIFICATION</span>
        <span class="k">elif</span> <span class="n">model</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">==</span> <span class="s1">&#39;pyspark.ml.regression&#39;</span><span class="p">:</span>
            <span class="n">m_type</span> <span class="o">=</span> <span class="n">SparkModelType</span><span class="o">.</span><span class="n">REGRESSION</span>
        <span class="k">elif</span> <span class="n">model</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">==</span> <span class="s1">&#39;pyspark.ml.clustering&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;probabilityCol&#39;</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">explainParams</span><span class="p">():</span>
                <span class="n">m_type</span> <span class="o">=</span> <span class="n">SparkModelType</span><span class="o">.</span><span class="n">CLUSTERING_WITH_PROB</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">m_type</span> <span class="o">=</span> <span class="n">SparkModelType</span><span class="o">.</span><span class="n">CLUSTERING_WO_PROB</span>

        <span class="k">return</span> <span class="n">m_type</span></div>

<div class="viewcode-block" id="SparkUtils.log_spark_model"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.SparkUtils.log_spark_model">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">log_spark_model</span><span class="p">(</span><span class="n">splice_context</span><span class="p">:</span> <span class="n">PySpliceContext</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">SparkModel</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inserts a Serialized spark model into the database as an artifact</span>

<span class="sd">        :param splice_context: (PySpliceContext) The PySpliceContext</span>
<span class="sd">        :param model: (SparkModel) the trained Spark model</span>
<span class="sd">        :param name: (str) the name to give the saved model</span>
<span class="sd">        :param run_id: (str) the run id associated to associate to this model</span>
<span class="sd">        :return: (None)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">jvm</span> <span class="o">=</span> <span class="n">splice_context</span><span class="o">.</span><span class="n">jvm</span>
        <span class="n">java_import</span><span class="p">(</span><span class="n">jvm</span><span class="p">,</span> <span class="s2">&quot;java.io.{BinaryOutputStream, ObjectOutputStream, ByteArrayInputStream}&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">SparkUtils</span><span class="o">.</span><span class="n">is_spark_pipeline</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">PipelineModel</span><span class="p">(</span>
                <span class="n">stages</span><span class="o">=</span><span class="p">[</span><span class="n">model</span><span class="p">]</span>
            <span class="p">)</span>  <span class="c1"># create a pipeline with only the model if a model is passed in</span>

        <span class="n">baos</span> <span class="o">=</span> <span class="n">jvm</span><span class="o">.</span><span class="n">java</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">ByteArrayOutputStream</span><span class="p">()</span>  <span class="c1"># serialize the PipelineModel to a byte array</span>
        <span class="n">oos</span> <span class="o">=</span> <span class="n">jvm</span><span class="o">.</span><span class="n">java</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">ObjectOutputStream</span><span class="p">(</span><span class="n">baos</span><span class="p">)</span>
        <span class="n">oos</span><span class="o">.</span><span class="n">writeObject</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_to_java</span><span class="p">())</span>
        <span class="n">oos</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">oos</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">insert_artifact</span><span class="p">(</span><span class="n">splice_context</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">baos</span><span class="o">.</span><span class="n">toByteArray</span><span class="p">(),</span> <span class="n">run_id</span><span class="p">,</span>
                        <span class="n">file_ext</span><span class="o">=</span><span class="s1">&#39;spark&#39;</span><span class="p">)</span>  <span class="c1"># write the byte stream to the db as a BLOB</span></div>

<div class="viewcode-block" id="SparkUtils.load_spark_model"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.SparkUtils.load_spark_model">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">load_spark_model</span><span class="p">(</span><span class="n">splice_ctx</span><span class="p">:</span> <span class="n">PySpliceContext</span><span class="p">,</span> <span class="n">spark_pipeline_blob</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SparkModel</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads a Serialized Spark Model into a Spark Pipeline</span>

<span class="sd">        :param splice_ctx: (PySpliceContext) The PySpliceContext</span>
<span class="sd">        :param spark_pipeline_blob: (object) The serialized model object</span>
<span class="sd">        :return: (SparkModel) The deserialized Spark model pipeline</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">jvm</span> <span class="o">=</span> <span class="n">splice_ctx</span><span class="o">.</span><span class="n">jvm</span>
        <span class="n">bis</span> <span class="o">=</span> <span class="n">jvm</span><span class="o">.</span><span class="n">java</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">ByteArrayInputStream</span><span class="p">(</span><span class="n">spark_pipeline_blob</span><span class="p">)</span>
        <span class="n">ois</span> <span class="o">=</span> <span class="n">jvm</span><span class="o">.</span><span class="n">java</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">ObjectInputStream</span><span class="p">(</span><span class="n">bis</span><span class="p">)</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">PipelineModel</span><span class="o">.</span><span class="n">_from_java</span><span class="p">(</span><span class="n">ois</span><span class="o">.</span><span class="n">readObject</span><span class="p">())</span>  <span class="c1"># convert object from Java</span>
                                                               <span class="c1"># PipelineModel to Python PipelineModel</span>
        <span class="n">ois</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">stages</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">SparkUtils</span><span class="o">.</span><span class="n">is_spark_pipeline</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">stages</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">stages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">pipeline</span></div>

<div class="viewcode-block" id="SparkUtils.prep_model_for_deployment"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.SparkUtils.prep_model_for_deployment">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">prep_model_for_deployment</span><span class="p">(</span><span class="n">splice_context</span><span class="p">:</span> <span class="n">PySpliceContext</span><span class="p">,</span>
                                  <span class="n">fittedPipe</span><span class="p">:</span> <span class="n">PipelineModel</span><span class="p">,</span>
                                  <span class="n">classes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                                  <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                  <span class="n">df</span><span class="p">:</span> <span class="n">SparkDF</span><span class="p">,</span>
                                  <span class="n">pred_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
                                  <span class="n">sklearn_args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">SparkModelType</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        All preprocessing steps to prepare for in DB deployment. Get the mleap model, get class labels</span>

<span class="sd">        :param fittedPipe:</span>
<span class="sd">        :param df:</span>
<span class="sd">        :param classes:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get model type</span>
        <span class="n">model_type</span> <span class="o">=</span> <span class="n">SparkUtils</span><span class="o">.</span><span class="n">get_model_type</span><span class="p">(</span><span class="n">fittedPipe</span><span class="p">)</span>
        <span class="c1"># See if the labels are in an IndexToString stage. Will either return List[str] or empty []</span>
        <span class="n">potential_clases</span> <span class="o">=</span> <span class="n">SparkUtils</span><span class="o">.</span><span class="n">try_get_class_labels</span><span class="p">(</span><span class="n">fittedPipe</span><span class="p">)</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="n">classes</span> <span class="k">if</span> <span class="n">classes</span> <span class="k">else</span> <span class="n">potential_clases</span>
        <span class="k">if</span> <span class="n">classes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SparkModelType</span><span class="o">.</span><span class="n">CLASSIFICATION</span><span class="p">,</span> <span class="n">SparkModelType</span><span class="o">.</span><span class="n">CLUSTERING_WITH_PROB</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Prediction labels found but model is not type Classification. Removing labels&#39;</span><span class="p">)</span>
                <span class="n">classes</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># handling spaces in class names</span>
                <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Prediction labels found. Using </span><span class="si">{</span><span class="n">classes</span><span class="si">}</span><span class="s1"> as labels for predictions </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">)))</span><span class="si">}</span><span class="s1"> respectively&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SparkModelType</span><span class="o">.</span><span class="n">CLASSIFICATION</span><span class="p">,</span> <span class="n">SparkModelType</span><span class="o">.</span><span class="n">CLUSTERING_WITH_PROB</span><span class="p">):</span>
                <span class="c1"># Add a column for each class of the prediction to output the probability of the prediction</span>
                <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;C</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">SparkUtils</span><span class="o">.</span><span class="n">get_num_classes</span><span class="p">(</span><span class="n">fittedPipe</span><span class="p">))]</span>
        <span class="c1"># See if the df passed in has already been transformed.</span>
        <span class="c1"># If not, transform it</span>
        <span class="k">if</span> <span class="s1">&#39;prediction&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">fittedPipe</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="c1"># Get the Mleap model and insert it into the MODELS table</span>
        <span class="n">mleap_model</span> <span class="o">=</span> <span class="n">get_mleap_model</span><span class="p">(</span><span class="n">splice_context</span><span class="p">,</span> <span class="n">fittedPipe</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">run_id</span><span class="p">)</span>
        <span class="n">model_already_exists</span> <span class="o">=</span> <span class="n">insert_mleap_model</span><span class="p">(</span><span class="n">splice_context</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">mleap_model</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">model_already_exists</span></div></div>


<div class="viewcode-block" id="get_model_library"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.get_model_library">[docs]</a><span class="k">def</span> <span class="nf">get_model_library</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DBLibraries</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets the model library of a trained model</span>

<span class="sd">    :param model: The trained model</span>
<span class="sd">    :return: DBLibraries</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">H2OModel</span><span class="p">):</span>
        <span class="n">lib</span> <span class="o">=</span> <span class="n">DBLibraries</span><span class="o">.</span><span class="n">H2OMOJO</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">SparkModel</span><span class="p">):</span>
        <span class="n">lib</span> <span class="o">=</span> <span class="n">DBLibraries</span><span class="o">.</span><span class="n">MLeap</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">ScikitModel</span><span class="p">):</span>
        <span class="n">lib</span> <span class="o">=</span> <span class="n">DBLibraries</span><span class="o">.</span><span class="n">SKLearn</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">KerasModel</span><span class="p">):</span>
        <span class="n">lib</span> <span class="o">=</span> <span class="n">DBLibraries</span><span class="o">.</span><span class="n">Keras</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SpliceMachineException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Submitted Model is not valid for database deployment! Valid models are </span><span class="si">{</span><span class="n">DBLibraries</span><span class="o">.</span><span class="n">SUPPORTED_LIBRARIES</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lib</span></div>


<div class="viewcode-block" id="find_inputs_by_output"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.find_inputs_by_output">[docs]</a><span class="k">def</span> <span class="nf">find_inputs_by_output</span><span class="p">(</span><span class="n">dictionary</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find the input columns for a given output column</span>

<span class="sd">    :param dictionary: dictionary to search</span>
<span class="sd">    :param value: column</span>
<span class="sd">    :return: None if not found, otherwise first column</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dictionary</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span><span class="p">:</span>  <span class="c1"># output column is always the last one</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">keys</span></div>


<div class="viewcode-block" id="get_user"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.get_user">[docs]</a><span class="k">def</span> <span class="nf">get_user</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the current logged in user to Jupyter</span>

<span class="sd">    :return: (str) name of the logged in user</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">uname</span> <span class="o">=</span> <span class="n">env_vars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;JUPYTERHUB_USER&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">env_vars</span><span class="p">[</span><span class="s1">&#39;USER&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">uname</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="s2">&quot;Could not determine current running user. Running MLManager outside of Splice Machine&quot;</span>
            <span class="s2">&quot; Cloud Jupyter is currently unsupported&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="insert_model"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.insert_model">[docs]</a><span class="k">def</span> <span class="nf">insert_model</span><span class="p">(</span><span class="n">splice_context</span><span class="p">:</span> <span class="n">PySpliceContext</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">byte_array</span><span class="p">:</span> <span class="nb">bytearray</span><span class="p">,</span> <span class="n">library</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Insert a serialized model into the Mlmanager models table for in database model deployment</span>

<span class="sd">    :param splice_context: (PySpliceContext) The PySpliceContext</span>
<span class="sd">    :param run_id: (str) mlflow run id</span>
<span class="sd">    :param byte_array: (bytearray) byte array</span>
<span class="sd">    :param library: (str) The library of the model (mleap, h2omojo etc)</span>
<span class="sd">    :param version: (str) The version of the library</span>
<span class="sd">    :return: bool whether or not the model already exists</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If a model with this run_id already exists in the table, gracefully fail</span>
    <span class="c1"># May be faster to use prepared statement</span>
    <span class="n">model_exists</span> <span class="o">=</span> <span class="n">splice_context</span><span class="o">.</span><span class="n">df</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;select count(*) from </span><span class="si">{</span><span class="n">SQL</span><span class="o">.</span><span class="n">MLMANAGER_SCHEMA</span><span class="si">}</span><span class="s1">.models where RUN_UUID=</span><span class="se">\&#39;</span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">model_exists</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s1">&#39;A model with this run ID is already deployed. We are NOT replacing it. We will use the currently existing model.</span><span class="se">\n</span><span class="s1">To replace, use a new run_id&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">db_connection</span> <span class="o">=</span> <span class="n">splice_context</span><span class="o">.</span><span class="n">getConnection</span><span class="p">()</span>
        <span class="n">file_size</span> <span class="o">=</span> <span class="n">getsizeof</span><span class="p">(</span><span class="n">byte_array</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving model of size: </span><span class="si">{</span><span class="n">file_size</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="si">}</span><span class="s2"> KB to Splice Machine DB&quot;</span><span class="p">)</span>
        <span class="n">binary_input_stream</span> <span class="o">=</span> <span class="n">splice_context</span><span class="o">.</span><span class="n">jvm</span><span class="o">.</span><span class="n">java</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">ByteArrayInputStream</span><span class="p">(</span><span class="n">byte_array</span><span class="p">)</span>

        <span class="n">prepared_statement</span> <span class="o">=</span> <span class="n">db_connection</span><span class="o">.</span><span class="n">prepareStatement</span><span class="p">(</span><span class="n">SQL</span><span class="o">.</span><span class="n">MODEL_INSERT_SQL</span><span class="p">)</span>
        <span class="n">prepared_statement</span><span class="o">.</span><span class="n">setString</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">run_id</span><span class="p">)</span>
        <span class="n">prepared_statement</span><span class="o">.</span><span class="n">setBinaryStream</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">binary_input_stream</span><span class="p">)</span>
        <span class="n">prepared_statement</span><span class="o">.</span><span class="n">setString</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">library</span><span class="p">)</span>
        <span class="n">prepared_statement</span><span class="o">.</span><span class="n">setString</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>

        <span class="n">prepared_statement</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="n">prepared_statement</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="insert_artifact"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.insert_artifact">[docs]</a><span class="k">def</span> <span class="nf">insert_artifact</span><span class="p">(</span><span class="n">splice_context</span><span class="p">:</span> <span class="n">PySpliceContext</span><span class="p">,</span>
                    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="n">byte_array</span><span class="p">:</span> <span class="nb">bytearray</span><span class="p">,</span>
                    <span class="n">run_uuid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="n">file_ext</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Insert a serialized object into the Mlmanager artifacts table</span>

<span class="sd">    :param splice_context: (PySpliceContext) the PySpliceContext</span>
<span class="sd">    :param name: (str) the path to store the binary under (with respect to the current run)</span>
<span class="sd">    :param byte_array: (bytearray) Java byte array</span>
<span class="sd">    :param run_uuid: (str) run uuid for the run</span>
<span class="sd">    :param file_ext: (str) the file extension of the model (used for downloading)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">db_connection</span> <span class="o">=</span> <span class="n">splice_context</span><span class="o">.</span><span class="n">getConnection</span><span class="p">()</span>
    <span class="n">file_size</span> <span class="o">=</span> <span class="n">getsizeof</span><span class="p">(</span><span class="n">byte_array</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving artifact of size: </span><span class="si">{</span><span class="n">file_size</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="si">}</span><span class="s2"> KB to Splice Machine DB&quot;</span><span class="p">)</span>
    <span class="n">binary_input_stream</span> <span class="o">=</span> <span class="n">splice_context</span><span class="o">.</span><span class="n">jvm</span><span class="o">.</span><span class="n">java</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">ByteArrayInputStream</span><span class="p">(</span><span class="n">byte_array</span><span class="p">)</span>
    <span class="n">prepared_statement</span> <span class="o">=</span> <span class="n">db_connection</span><span class="o">.</span><span class="n">prepareStatement</span><span class="p">(</span><span class="n">SQL</span><span class="o">.</span><span class="n">ARTIFACT_INSERT_SQL</span><span class="p">)</span>
    <span class="n">prepared_statement</span><span class="o">.</span><span class="n">setString</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">run_uuid</span><span class="p">)</span>
    <span class="n">prepared_statement</span><span class="o">.</span><span class="n">setString</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">prepared_statement</span><span class="o">.</span><span class="n">setInt</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">file_size</span><span class="p">)</span>
    <span class="n">prepared_statement</span><span class="o">.</span><span class="n">setBinaryStream</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">binary_input_stream</span><span class="p">)</span>
    <span class="n">prepared_statement</span><span class="o">.</span><span class="n">setString</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">file_ext</span><span class="p">)</span>

    <span class="n">prepared_statement</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
    <span class="n">prepared_statement</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="get_pod_uri"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.get_pod_uri">[docs]</a><span class="k">def</span> <span class="nf">get_pod_uri</span><span class="p">(</span><span class="n">pod</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">str</span> <span class="ow">or</span> <span class="nb">int</span><span class="p">,</span> <span class="n">_testing</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get address of MLFlow Container for Kubernetes</span>

<span class="sd">    :param pod: (str) the url of the mlflow pod</span>
<span class="sd">    :param port: (str or int) the port of the pod for mlflow communication</span>
<span class="sd">    :param _testing: (bool) Whether you are testing [default False]</span>
<span class="sd">    :return: (str) the pod URI</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">_testing</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;http://</span><span class="si">{</span><span class="n">pod</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c1"># mlflow docker container endpoint</span>

    <span class="k">elif</span> <span class="s1">&#39;MLFLOW_URL&#39;</span> <span class="ow">in</span> <span class="n">env_vars</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">env_vars</span><span class="p">[</span><span class="s1">&#39;MLFLOW_URL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;:5001&#39;</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s1">&#39;</span>  <span class="c1"># 5001 or 5003 for tracking or deployment</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
            <span class="s2">&quot;Uh Oh! MLFLOW_URL variable was not found... are you running in the Cloud service?&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">url</span></div>


<div class="viewcode-block" id="get_mleap_model"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.get_mleap_model">[docs]</a><span class="k">def</span> <span class="nf">get_mleap_model</span><span class="p">(</span><span class="n">splice_context</span><span class="p">:</span> <span class="n">PySpliceContext</span><span class="p">,</span>
                    <span class="n">fittedPipe</span><span class="p">:</span><span class="n">PipelineModel</span><span class="p">,</span>
                    <span class="n">df</span><span class="p">:</span> <span class="n">SparkDF</span><span class="p">,</span>
                    <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Turns a fitted Spark Pipeline into an Mleap Transformer</span>

<span class="sd">    :param splice_context: pysplicectx</span>
<span class="sd">    :param fittedPipe: Fitted Spark Pipeline</span>
<span class="sd">    :param df: A TRANSFORMED dataframe. ie a dataframe that the pipeline has called .transform() on</span>
<span class="sd">    :param run_id: (str) the MLFlow run associated with the model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">SimpleSparkSerializer</span><span class="p">()</span>  <span class="c1"># Adds the serializeToBundle function from Mleap</span>
    <span class="k">if</span> <span class="s1">&#39;tmp&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rbash</span><span class="p">(</span><span class="s1">&#39;ls /&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">():</span>
        <span class="n">bash</span><span class="p">(</span><span class="s1">&#39;mkdir /tmp&#39;</span><span class="p">)</span>
    <span class="c1"># Serialize the Spark model into Mleap format</span>
    <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="s1">.zip&#39;</span> <span class="ow">in</span> <span class="n">rbash</span><span class="p">(</span><span class="s1">&#39;ls /tmp&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">():</span>
        <span class="n">remove</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/tmp/</span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="s1">.zip&#39;</span><span class="p">)</span>
    <span class="n">fittedPipe</span><span class="o">.</span><span class="n">serializeToBundle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;jar:file:///tmp/</span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="s2">.zip&quot;</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>

    <span class="n">jvm</span> <span class="o">=</span> <span class="n">splice_context</span><span class="o">.</span><span class="n">jvm</span>
    <span class="n">java_import</span><span class="p">(</span><span class="n">jvm</span><span class="p">,</span> <span class="s2">&quot;com.splicemachine.mlrunner.FileRetriever&quot;</span><span class="p">)</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">jvm</span><span class="o">.</span><span class="n">FileRetriever</span><span class="o">.</span><span class="n">loadBundle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;jar:file:///tmp/</span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="s1">.zip&#39;</span><span class="p">)</span>
    <span class="n">remove</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/tmp/</span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="s1">.zip&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">obj</span></div>


<div class="viewcode-block" id="insert_mleap_model"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.insert_mleap_model">[docs]</a><span class="k">def</span> <span class="nf">insert_mleap_model</span><span class="p">(</span><span class="n">splice_context</span><span class="p">:</span> <span class="n">PySpliceContext</span><span class="p">,</span>
                       <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                       <span class="n">model</span><span class="p">:</span> <span class="n">PipelineModel</span> <span class="ow">or</span> <span class="n">SparkModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Insert an MLeap Transformer model into the database as a Blob</span>

<span class="sd">    :param splice_context: pysplicectx</span>
<span class="sd">    :param model_id: (str) the mlflow run_id that the model is associated with</span>
<span class="sd">    (with respect to the current run)</span>
<span class="sd">    :param model: (PipelineModel) the fitted Mleap Transformer (pipeline)</span>
<span class="sd">    :return: (bool) whether or not the model exists already</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Serialize Mleap model to BLOB</span>
    <span class="n">baos</span> <span class="o">=</span> <span class="n">splice_context</span><span class="o">.</span><span class="n">jvm</span><span class="o">.</span><span class="n">java</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">ByteArrayOutputStream</span><span class="p">()</span>
    <span class="n">oos</span> <span class="o">=</span> <span class="n">splice_context</span><span class="o">.</span><span class="n">jvm</span><span class="o">.</span><span class="n">java</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">ObjectOutputStream</span><span class="p">(</span><span class="n">baos</span><span class="p">)</span>
    <span class="n">oos</span><span class="o">.</span><span class="n">writeObject</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">oos</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">oos</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">byte_array</span> <span class="o">=</span> <span class="n">baos</span><span class="o">.</span><span class="n">toByteArray</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">insert_model</span><span class="p">(</span><span class="n">splice_context</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">byte_array</span><span class="p">,</span> <span class="s1">&#39;mleap&#39;</span><span class="p">,</span> <span class="n">MLEAP_VERSION</span><span class="p">)</span></div>


<div class="viewcode-block" id="validate_primary_key"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.validate_primary_key">[docs]</a><span class="k">def</span> <span class="nf">validate_primary_key</span><span class="p">(</span><span class="n">splice_ctx</span><span class="p">:</span> <span class="n">PySpliceContext</span><span class="p">,</span>
                         <span class="n">primary_key</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">schema</span><span class="p">:</span> <span class="nb">str</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">table</span><span class="p">:</span> <span class="nb">str</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validates the primary key passed by the user conforms to SQL. If the user is deploying to an existing table</span>
<span class="sd">    This verifies that the table has a primary key</span>

<span class="sd">    :param splice_ctx: (PySpliceContext) The PySpliceContext</span>
<span class="sd">    :param primary_key: (List[Tuple[str,str]]) column name, SQL datatype for the primary key(s) of the table</span>
<span class="sd">    :param schema: (str) the name of the schema being deployed to</span>
<span class="sd">    :param table (str) the name of the table being deployed to</span>
<span class="sd">    :return: (List[str]) the primary keys</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">primary_key</span><span class="p">:</span>
        <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;[^a-zA-Z]&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">primary_key</span><span class="p">:</span>
            <span class="n">sql_datatype</span> <span class="o">=</span> <span class="n">regex</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">sql_datatype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SQL_TYPES</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Primary key parameter </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> does not conform to SQL type.&#39;</span>
                                 <span class="sa">f</span><span class="s1">&#39;Value </span><span class="si">{</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1"> should be a SQL type but isn</span><span class="se">\&#39;</span><span class="s1">t&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="n">splice_ctx</span><span class="o">.</span><span class="n">getConnection</span><span class="p">()</span><span class="o">.</span><span class="n">prepareStatement</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CALL sysibm.sqlprimarykeys(&#39;splicedb&#39;,&#39;</span><span class="si">{</span><span class="n">schema</span><span class="si">}</span><span class="s2">&#39;,&#39;</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">&#39;,&#39;&#39;)&quot;</span><span class="p">)</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">executeQuery</span><span class="p">()</span>
        <span class="n">pks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">rs</span><span class="o">.</span><span class="n">next</span><span class="p">():</span> <span class="n">pks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rs</span><span class="o">.</span><span class="n">getString</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pks</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SpliceMachineException</span><span class="p">(</span><span class="s1">&#39;The provided table has no primary keys. It must have a primary key before deployment&#39;</span><span class="p">)</span>
        <span class="n">pks</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pks</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">pks</span></div>


<div class="viewcode-block" id="create_model_deployment_table"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.create_model_deployment_table">[docs]</a><span class="k">def</span> <span class="nf">create_model_deployment_table</span><span class="p">(</span><span class="n">splice_context</span><span class="p">:</span> <span class="n">PySpliceContext</span><span class="p">,</span>
                                  <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                  <span class="n">schema_table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                  <span class="n">schema_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                  <span class="n">classes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                                  <span class="n">primary_key</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]],</span>
                                  <span class="n">model_type</span><span class="p">:</span> <span class="n">Enum</span><span class="p">,</span>
                                  <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates the table that holds the columns of the feature vector as well as a unique MOMENT_ID</span>

<span class="sd">    :param splice_context: pysplicectx</span>
<span class="sd">    :param run_id: (str) the run_id for this model</span>
<span class="sd">    :param schema_table_name: (str) the schema.table to create the table under</span>
<span class="sd">    :param schema_str: (str) the structure of the schema of the table as a string (col_name TYPE,)</span>
<span class="sd">    :param classes: (List[str]) the labels of the model (if they exist)</span>
<span class="sd">    :param primary_key: List[Tuple[str,str]] column name, SQL datatype for the primary key(s) of the table</span>
<span class="sd">    :param model_type: (ModelType) Whether the model is a Regression, Classification or Clustering (with/without probabilities)</span>
<span class="sd">    :param verbose: (bool) whether to print the SQL query</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">splice_context</span><span class="o">.</span><span class="n">tableExists</span><span class="p">(</span><span class="n">schema_table_name</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SpliceMachineException</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;The table </span><span class="si">{</span><span class="n">schema_table_name</span><span class="si">}</span><span class="s1"> already exists. To deploy to an existing table, do not pass in a dataframe or &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;The create_model_table parameter&#39;</span><span class="p">)</span>
    <span class="n">SQL_TABLE</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;CREATE TABLE </span><span class="si">{</span><span class="n">schema_table_name</span><span class="si">}</span><span class="s2"> (</span><span class="se">\</span>
<span class="s2">                </span><span class="se">\t</span><span class="s2">CUR_USER VARCHAR(50) DEFAULT CURRENT_USER,</span>
<span class="s2">                </span><span class="se">\t</span><span class="s2">EVAL_TIME TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</span>
<span class="s2">                </span><span class="se">\t</span><span class="s2">RUN_ID VARCHAR(50) DEFAULT &#39;</span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="s2">&#39;,</span>
<span class="s2">                </span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">schema_str</span><span class="si">}</span><span class="s2"></span>
<span class="s2">                &quot;&quot;&quot;</span>

    <span class="n">pk_cols</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">primary_key</span><span class="p">:</span>
        <span class="c1"># If pk is already in the schema_string, don&#39;t add another column. PK may be an existing value</span>
        <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">schema_str</span><span class="p">:</span>
            <span class="n">SQL_TABLE</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">,</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">pk_cols</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">,&#39;</span>


    <span class="k">if</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SparkModelType</span><span class="o">.</span><span class="n">REGRESSION</span><span class="p">,</span> <span class="n">H2OModelType</span><span class="o">.</span><span class="n">REGRESSION</span><span class="p">,</span> <span class="n">SklearnModelType</span><span class="o">.</span><span class="n">REGRESSION</span><span class="p">,</span>
                      <span class="n">KerasModelType</span><span class="o">.</span><span class="n">REGRESSION</span><span class="p">):</span>
        <span class="n">SQL_TABLE</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">PREDICTION DOUBLE,</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="k">elif</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SparkModelType</span><span class="o">.</span><span class="n">CLASSIFICATION</span><span class="p">,</span> <span class="n">SparkModelType</span><span class="o">.</span><span class="n">CLUSTERING_WITH_PROB</span><span class="p">,</span>
                       <span class="n">H2OModelType</span><span class="o">.</span><span class="n">CLASSIFICATION</span><span class="p">):</span>
        <span class="n">SQL_TABLE</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">PREDICTION VARCHAR(5000),</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
            <span class="n">SQL_TABLE</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&quot; DOUBLE,</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">H2OModelType</span><span class="o">.</span><span class="n">KEY_VALUE</span><span class="p">,</span> <span class="n">SklearnModelType</span><span class="o">.</span><span class="n">KEY_VALUE</span><span class="p">,</span> <span class="n">KerasModelType</span><span class="o">.</span><span class="n">KEY_VALUE</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
            <span class="n">SQL_TABLE</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&quot; DOUBLE,</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="k">elif</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SparkModelType</span><span class="o">.</span><span class="n">CLUSTERING_WO_PROB</span><span class="p">,</span> <span class="n">H2OModelType</span><span class="o">.</span><span class="n">SINGULAR</span><span class="p">,</span> <span class="n">SklearnModelType</span><span class="o">.</span><span class="n">POINT_PREDICTION_CLF</span><span class="p">):</span>
        <span class="n">SQL_TABLE</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">PREDICTION INT,</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="n">SQL_TABLE</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">PRIMARY KEY(</span><span class="si">{</span><span class="n">pk_cols</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">)&#39;</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">SQL_TABLE</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">splice_context</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">SQL_TABLE</span><span class="p">)</span></div>

<div class="viewcode-block" id="alter_model_table"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.alter_model_table">[docs]</a><span class="k">def</span> <span class="nf">alter_model_table</span><span class="p">(</span><span class="n">splice_context</span><span class="p">:</span> <span class="n">PySpliceContext</span><span class="p">,</span>
                      <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                      <span class="n">schema_table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                      <span class="n">classes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                      <span class="n">model_type</span><span class="p">:</span> <span class="n">Enum</span><span class="p">,</span>
                      <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Alters the provided table for deployment. Adds columns for storing model results as well as metadata such as</span>
<span class="sd">    current user, eval time, run_id, and the prediction label columns</span>

<span class="sd">    :param splice_context: pysplicectx</span>
<span class="sd">    :param run_id: (str) the run_id for this model</span>
<span class="sd">    :param schema_table_name: (str) the schema.table to create the table under</span>
<span class="sd">    :param classes: (List[str]) the labels of the model (if they exist)</span>
<span class="sd">    :param primary_key: List[Tuple[str,str]] column name, SQL datatype for the primary key(s) of the table</span>
<span class="sd">    :param model_type: (ModelType) Whether the model is a Regression, Classification or Clustering (with/without probabilities)</span>
<span class="sd">    :param verbose: (bool) whether to print the SQL query</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Table needs to exist</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">splice_context</span><span class="o">.</span><span class="n">tableExists</span><span class="p">(</span><span class="n">schema_table_name</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SpliceMachineException</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;The table </span><span class="si">{</span><span class="n">schema_table_name</span><span class="si">}</span><span class="s1"> does not exist. To create a new table for deployment, pass in a dataframe and &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;The set create_model_table=True&#39;</span><span class="p">)</span>

    <span class="c1"># Currently we only support deploying 1 model to a table</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="n">splice_context</span><span class="o">.</span><span class="n">getSchema</span><span class="p">(</span><span class="n">schema_table_name</span><span class="p">)</span>
    <span class="n">reserved_fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;CUR_USER&#39;</span><span class="p">,</span> <span class="s1">&#39;EVAL_TIME&#39;</span><span class="p">,</span> <span class="s1">&#39;RUN_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;PREDICTION&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">classes</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">reserved_fields</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SpliceMachineException</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The table </span><span class="si">{</span><span class="n">schema_table_name</span><span class="si">}</span><span class="s1"> looks like it already has values associated with &#39;</span>
                                         <span class="sa">f</span><span class="s1">&#39;a deployed model. Only 1 model can be deployed to a table currently.&#39;</span>
                                         <span class="sa">f</span><span class="s1">&#39;The table cannot have the following fields: </span><span class="si">{</span><span class="n">reserved_fields</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Splice cannot currently add multiple columns in an alter statement so we need to make a bunch and execute all of them</span>
    <span class="n">SQL_ALTER_TABLE</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">alter_table_syntax</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;ALTER TABLE </span><span class="si">{</span><span class="n">schema_table_name</span><span class="si">}</span><span class="s1"> ADD COLUMN&#39;</span>
    <span class="n">SQL_ALTER_TABLE</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">alter_table_syntax</span><span class="si">}</span><span class="s1"> CUR_USER VARCHAR(50) DEFAULT CURRENT_USER&#39;</span><span class="p">)</span>
    <span class="n">SQL_ALTER_TABLE</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">alter_table_syntax</span><span class="si">}</span><span class="s1"> EVAL_TIME TIMESTAMP DEFAULT CURRENT_TIMESTAMP&#39;</span><span class="p">)</span>
    <span class="n">SQL_ALTER_TABLE</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">alter_table_syntax</span><span class="si">}</span><span class="s1"> RUN_ID VARCHAR(50) DEFAULT </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Add the correct prediction type</span>
    <span class="k">if</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SparkModelType</span><span class="o">.</span><span class="n">REGRESSION</span><span class="p">,</span> <span class="n">H2OModelType</span><span class="o">.</span><span class="n">REGRESSION</span><span class="p">,</span> <span class="n">SklearnModelType</span><span class="o">.</span><span class="n">REGRESSION</span><span class="p">,</span>
                      <span class="n">KerasModelType</span><span class="o">.</span><span class="n">REGRESSION</span><span class="p">):</span>
        <span class="n">SQL_ALTER_TABLE</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">alter_table_syntax</span><span class="si">}</span><span class="s1"> PREDICTION DOUBLE&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SparkModelType</span><span class="o">.</span><span class="n">CLASSIFICATION</span><span class="p">,</span> <span class="n">SparkModelType</span><span class="o">.</span><span class="n">CLUSTERING_WITH_PROB</span><span class="p">,</span>
                       <span class="n">H2OModelType</span><span class="o">.</span><span class="n">CLASSIFICATION</span><span class="p">):</span>
        <span class="n">SQL_ALTER_TABLE</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">alter_table_syntax</span><span class="si">}</span><span class="s1"> PREDICTION VARCHAR(5000)&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
            <span class="n">SQL_ALTER_TABLE</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">alter_table_syntax</span><span class="si">}</span><span class="s1"> &quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&quot; DOUBLE&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">H2OModelType</span><span class="o">.</span><span class="n">KEY_VALUE</span><span class="p">,</span> <span class="n">SklearnModelType</span><span class="o">.</span><span class="n">KEY_VALUE</span><span class="p">,</span> <span class="n">KerasModelType</span><span class="o">.</span><span class="n">KEY_VALUE</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
            <span class="n">SQL_ALTER_TABLE</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">alter_table_syntax</span><span class="si">}</span><span class="s1"> &quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&quot; DOUBLE&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SparkModelType</span><span class="o">.</span><span class="n">CLUSTERING_WO_PROB</span><span class="p">,</span> <span class="n">H2OModelType</span><span class="o">.</span><span class="n">SINGULAR</span><span class="p">,</span> <span class="n">SklearnModelType</span><span class="o">.</span><span class="n">POINT_PREDICTION_CLF</span><span class="p">):</span>
        <span class="n">SQL_ALTER_TABLE</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">alter_table_syntax</span><span class="si">}</span><span class="s1"> PREDICTION INT&#39;</span><span class="p">)</span>

    <span class="c1"># SQL_TABLE += f&#39;\tPRIMARY KEY({pk_cols.rstrip(&quot;,&quot;)})\n)&#39;</span>
    <span class="k">for</span> <span class="n">sql</span> <span class="ow">in</span> <span class="n">SQL_ALTER_TABLE</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">splice_context</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span></div>

<div class="viewcode-block" id="create_vti_prediction_trigger"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.create_vti_prediction_trigger">[docs]</a><span class="k">def</span> <span class="nf">create_vti_prediction_trigger</span><span class="p">(</span><span class="n">splice_context</span><span class="p">:</span> <span class="n">PySpliceContext</span><span class="p">,</span>
                                  <span class="n">schema_table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                  <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                  <span class="n">feature_columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                                  <span class="n">schema_types</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">],</span>
                                  <span class="n">schema_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                  <span class="n">primary_key</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span>
                                  <span class="n">classes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                                  <span class="n">model_type</span><span class="p">:</span> <span class="n">Enum</span><span class="p">,</span>
                                  <span class="n">sklearn_args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
                                  <span class="n">pred_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                  <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates the VTI trigger for model types that use VTIs instead of standard Java Functions</span>

<span class="sd">    :param splice_context: (PySpliceContext) the PySpliceContext</span>
<span class="sd">    :param schema_table_name: (str) the schema.table to create the table under</span>
<span class="sd">    :param run_id: (str) the run_id to deploy the model under</span>
<span class="sd">    :param feature_columns: (List[str]) the original features that are transformed into the final feature vector</span>
<span class="sd">    :param schema_types: (Dict[str, str]) a mapping of feature column to data type</span>
<span class="sd">    :param schema_str: (str) the structure of the schema of the table as a string (col_name TYPE,)</span>
<span class="sd">    :param primary_key: List[Tuple[str,str]] column name, SQL datatype for the primary key(s) of the table</span>
<span class="sd">    :param classes: (List[str]) the label columns of the model prediction</span>
<span class="sd">    :param model_type: (Enum) Whether the model is a Regression, Classification or Clustering (with/without probabilities)</span>
<span class="sd">    :param sklearn_args: (Dict[str,str]) Any custom scikit-learn prediction arguments</span>
<span class="sd">    :param pred_threshold: (float) the optional keras prediction threshold for predictions</span>
<span class="sd">    :param verbose: (bool) whether to print the SQL query</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">prediction_call</span> <span class="o">=</span> <span class="s2">&quot;new com.splicemachine.mlrunner.MLRunner(&#39;key_value&#39;, &#39;</span><span class="si">{run_id}</span><span class="s2">&#39;, </span><span class="si">{raw_data}</span><span class="s2">, &#39;</span><span class="si">{schema_str}</span><span class="s2">&#39;&quot;</span>

    <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="n">SklearnModelType</span><span class="o">.</span><span class="n">KEY_VALUE</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sklearn_args</span><span class="p">:</span> <span class="c1"># This must be a .transform call</span>
            <span class="n">predict_call</span><span class="p">,</span> <span class="n">predict_args</span> <span class="o">=</span> <span class="s1">&#39;transform&#39;</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="s1">&#39;predict_call&#39;</span> <span class="ow">in</span> <span class="n">sklearn_args</span> <span class="ow">and</span> <span class="s1">&#39;predict_args&#39;</span> <span class="ow">in</span> <span class="n">sklearn_args</span><span class="p">:</span>
            <span class="n">predict_call</span><span class="p">,</span> <span class="n">predict_args</span> <span class="o">=</span> <span class="n">sklearn_args</span><span class="p">[</span><span class="s1">&#39;predict_call&#39;</span><span class="p">],</span> <span class="n">sklearn_args</span><span class="p">[</span><span class="s1">&#39;predict_args&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;predict_args&#39;</span> <span class="ow">in</span> <span class="n">sklearn_args</span><span class="p">:</span>
            <span class="n">predict_call</span><span class="p">,</span> <span class="n">predict_args</span> <span class="o">=</span> <span class="s1">&#39;predict&#39;</span><span class="p">,</span> <span class="n">sklearn_args</span><span class="p">[</span><span class="s1">&#39;predict_args&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;predict_call&#39;</span> <span class="ow">in</span> <span class="n">sklearn_args</span><span class="p">:</span>
            <span class="n">predict_call</span><span class="p">,</span> <span class="n">predict_args</span> <span class="o">=</span> <span class="n">sklearn_args</span><span class="p">[</span><span class="s1">&#39;predict_call&#39;</span><span class="p">],</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SpliceMachineException</span><span class="p">(</span><span class="s1">&#39;You had an invalid key in your sklearn_args. Valid keys (predict_call, predict_args)&#39;</span><span class="p">)</span>

        <span class="n">prediction_call</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, &#39;</span><span class="si">{</span><span class="n">predict_call</span><span class="si">}</span><span class="s2">&#39;, &#39;</span><span class="si">{</span><span class="n">predict_args</span><span class="si">}</span><span class="s2">&#39;&quot;</span>

    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="n">KerasModelType</span><span class="o">.</span><span class="n">KEY_VALUE</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">pred_threshold</span><span class="p">:</span>
        <span class="n">prediction_call</span> <span class="o">+=</span>  <span class="sa">f</span><span class="s2">&quot;, &#39;</span><span class="si">{</span><span class="n">pred_threshold</span><span class="si">}</span><span class="s2">&#39;&quot;</span>

    <span class="n">prediction_call</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="n">schema_table_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">SQL_PRED_TRIGGER</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;CREATE TRIGGER </span><span class="si">{</span><span class="n">schema</span><span class="si">}</span><span class="s1">.runModel_</span><span class="si">{</span><span class="n">schema_table_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="se">\n</span><span class="s1"> </span><span class="se">\t</span><span class="s1">AFTER INSERT</span><span class="se">\n</span><span class="s1"> &#39;</span> \
                       <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">ON </span><span class="si">{</span><span class="n">schema_table_name</span><span class="si">}</span><span class="se">\n</span><span class="s1"> </span><span class="se">\t</span><span class="s1">REFERENCING NEW AS NEWROW</span><span class="se">\n</span><span class="s1"> </span><span class="se">\t</span><span class="s1">FOR EACH ROW</span><span class="se">\n</span><span class="s1"> </span><span class="se">\t\t</span><span class="s1">UPDATE &#39;</span> \
                       <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">schema_table_name</span><span class="si">}</span><span class="s1"> SET (&#39;</span>

    <span class="n">output_column_names</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># Names of the output columns from the model</span>
    <span class="n">output_cols_VTI_reference</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># Names references from the VTI (ie b.COL_NAME)</span>
    <span class="n">output_cols_schema</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># Names with their datatypes (always DOUBLE)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
        <span class="n">output_column_names</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&quot;,&#39;</span>
        <span class="n">output_cols_VTI_reference</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;b.&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&quot;,&#39;</span>
        <span class="n">output_cols_schema</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&quot; DOUBLE,&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="s1">&#39;prediction&#39;</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&quot; INT,&#39;</span> <span class="c1">#for sklearn predict_proba</span>

    <span class="n">raw_data</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">feature_columns</span><span class="p">):</span>
        <span class="n">raw_data</span> <span class="o">+=</span> <span class="s1">&#39;||&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">schema_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)]</span> <span class="o">==</span> <span class="s1">&#39;StringType&#39;</span><span class="p">:</span>
            <span class="n">raw_data</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;NEWROW.</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">||</span><span class="se">\&#39;</span><span class="s1">,</span><span class="se">\&#39;</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inner_cast</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;CAST(NEWROW.</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1"> as DECIMAL(38,10))&#39;</span> <span class="k">if</span> <span class="n">schema_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)]</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;FloatType&#39;</span><span class="p">,</span> <span class="s1">&#39;DoubleType&#39;</span><span class="p">,</span>
                                                                                           <span class="s1">&#39;DecimalType&#39;</span><span class="p">}</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;NEWROW.</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">raw_data</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;TRIM(CAST(</span><span class="si">{</span><span class="n">inner_cast</span><span class="si">}</span><span class="s1"> as CHAR(41)))||</span><span class="se">\&#39;</span><span class="s1">,</span><span class="se">\&#39;</span><span class="s1">&#39;</span>

    <span class="c1"># Cleanup + schema for PREDICT call</span>
    <span class="n">raw_data</span> <span class="o">=</span> <span class="n">raw_data</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;||&#39;</span><span class="p">)</span>
    <span class="n">schema_str_pred_call</span> <span class="o">=</span> <span class="n">schema_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

    <span class="n">prediction_call</span> <span class="o">=</span> <span class="n">prediction_call</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_id</span><span class="o">=</span><span class="n">run_id</span><span class="p">,</span> <span class="n">raw_data</span><span class="o">=</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">schema_str</span><span class="o">=</span><span class="n">schema_str_pred_call</span><span class="p">)</span>


    <span class="n">SQL_PRED_TRIGGER</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">output_column_names</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">) = (&#39;</span>
    <span class="n">SQL_PRED_TRIGGER</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;SELECT </span><span class="si">{</span><span class="n">output_cols_VTI_reference</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1"> FROM </span><span class="si">{</span><span class="n">prediction_call</span><span class="si">}</span><span class="s1">&#39;</span> \
                        <span class="sa">f</span><span class="s1">&#39; as b (</span><span class="si">{</span><span class="n">output_cols_schema</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">) WHERE 1=1) WHERE &#39;</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">primary_key</span><span class="p">:</span>
        <span class="n">SQL_PRED_TRIGGER</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> = NEWROW.</span><span class="si">{</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> AND&#39;</span>
    <span class="c1"># Remove last AND</span>
    <span class="n">SQL_PRED_TRIGGER</span> <span class="o">=</span> <span class="n">SQL_PRED_TRIGGER</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">SQL_PRED_TRIGGER</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">splice_context</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">SQL_PRED_TRIGGER</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="create_prediction_trigger"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.create_prediction_trigger">[docs]</a><span class="k">def</span> <span class="nf">create_prediction_trigger</span><span class="p">(</span><span class="n">splice_context</span><span class="p">:</span> <span class="n">PySpliceContext</span><span class="p">,</span>
                              <span class="n">schema_table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                              <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                              <span class="n">feature_columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                              <span class="n">schema_types</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">],</span>
                              <span class="n">schema_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                              <span class="n">primary_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                              <span class="n">model_type</span><span class="p">:</span> <span class="n">Enum</span><span class="p">,</span>
                              <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates the trigger that calls the model on data row insert. This trigger will call predict when a new row is inserted into the data table</span>
<span class="sd">    and update the row to contain the prediction(s)</span>

<span class="sd">    :param splice_context: (PySpliceContext) the PySpliceContext</span>
<span class="sd">    :param schema_table_name: (str) the schema.table to create the table under</span>
<span class="sd">    :param run_id: (str) the run_id to deploy the model under</span>
<span class="sd">    :param feature_columns: (List[str]) the original features that are transformed into the final feature vector</span>
<span class="sd">    :param schema_types: (Dict[str, str]) a mapping of feature column to data type</span>
<span class="sd">    :param schema_str: (str) the structure of the schema of the table as a string (col_name TYPE,)</span>
<span class="sd">    :param primary_key: List[Tuple[str,str]] column name, SQL datatype for the primary key(s) of the table</span>
<span class="sd">    :param model_type: (Enum) Whether the model is a Regression, Classification or Clustering (with/without probabilities)</span>
<span class="sd">    :param verbose: (bool) whether to print the SQL query</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SparkModelType</span><span class="o">.</span><span class="n">CLASSIFICATION</span><span class="p">,</span> <span class="n">H2OModelType</span><span class="o">.</span><span class="n">CLASSIFICATION</span><span class="p">):</span>
        <span class="n">prediction_call</span> <span class="o">=</span> <span class="s1">&#39;MLMANAGER.PREDICT_CLASSIFICATION&#39;</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SparkModelType</span><span class="o">.</span><span class="n">REGRESSION</span><span class="p">,</span> <span class="n">H2OModelType</span><span class="o">.</span><span class="n">REGRESSION</span><span class="p">,</span>
                        <span class="n">SklearnModelType</span><span class="o">.</span><span class="n">REGRESSION</span><span class="p">,</span> <span class="n">KerasModelType</span><span class="o">.</span><span class="n">REGRESSION</span><span class="p">):</span>
        <span class="n">prediction_call</span> <span class="o">=</span> <span class="s1">&#39;MLMANAGER.PREDICT_REGRESSION&#39;</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="n">SparkModelType</span><span class="o">.</span><span class="n">CLUSTERING_WITH_PROB</span><span class="p">:</span>
        <span class="n">prediction_call</span> <span class="o">=</span> <span class="s1">&#39;MLMANAGER.PREDICT_CLUSTER_PROBABILITIES&#39;</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SparkModelType</span><span class="o">.</span><span class="n">CLUSTERING_WO_PROB</span><span class="p">,</span> <span class="n">H2OModelType</span><span class="o">.</span><span class="n">SINGULAR</span><span class="p">,</span> <span class="n">SklearnModelType</span><span class="o">.</span><span class="n">POINT_PREDICTION_CLF</span><span class="p">):</span>
        <span class="n">prediction_call</span> <span class="o">=</span> <span class="s1">&#39;MLMANAGER.PREDICT_CLUSTER&#39;</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="n">H2OModelType</span><span class="o">.</span><span class="n">KEY_VALUE</span><span class="p">:</span>
        <span class="n">prediction_call</span> <span class="o">=</span> <span class="s1">&#39;MLMANAGER.PREDICT_KEY_VALUE&#39;</span>

    <span class="n">schema</span> <span class="o">=</span> <span class="n">schema_table_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">SQL_PRED_TRIGGER</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;CREATE TRIGGER </span><span class="si">{</span><span class="n">schema</span><span class="si">}</span><span class="s1">.runModel_</span><span class="si">{</span><span class="n">schema_table_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="se">\n</span><span class="s1"> </span><span class="se">\t</span><span class="s1">BEFORE INSERT</span><span class="se">\n</span><span class="s1"> &#39;</span> \
                       <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">ON </span><span class="si">{</span><span class="n">schema_table_name</span><span class="si">}</span><span class="se">\n</span><span class="s1"> </span><span class="se">\t</span><span class="s1">REFERENCING NEW AS NEWROW</span><span class="se">\n</span><span class="s1"> </span><span class="se">\t</span><span class="s1">FOR EACH ROW</span><span class="se">\n</span><span class="s1"> </span><span class="se">\t</span><span class="s1">BEGIN ATOMIC </span><span class="se">\t\t</span><span class="s1">&#39;</span> \
                       <span class="sa">f</span><span class="s1">&#39;SET NEWROW.PREDICTION=&#39;</span>

    <span class="n">SQL_PRED_TRIGGER</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prediction_call</span><span class="si">}</span><span class="s1">(</span><span class="se">\&#39;</span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">,&#39;</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">feature_columns</span><span class="p">):</span>
        <span class="n">SQL_PRED_TRIGGER</span> <span class="o">+=</span> <span class="s1">&#39;||&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">schema_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)]</span> <span class="o">==</span> <span class="s1">&#39;StringType&#39;</span><span class="p">:</span>
            <span class="n">SQL_PRED_TRIGGER</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;NEWROW.</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">||</span><span class="se">\&#39;</span><span class="s1">,</span><span class="se">\&#39;</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inner_cast</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;CAST(NEWROW.</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1"> as DECIMAL(38,10))&#39;</span> <span class="k">if</span> <span class="n">schema_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)]</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;FloatType&#39;</span><span class="p">,</span> <span class="s1">&#39;DoubleType&#39;</span><span class="p">,</span>
                                                                                               <span class="s1">&#39;DecimalType&#39;</span><span class="p">}</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;NEWROW.</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">SQL_PRED_TRIGGER</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;TRIM(CAST(</span><span class="si">{</span><span class="n">inner_cast</span><span class="si">}</span><span class="s1"> as CHAR(41)))||</span><span class="se">\&#39;</span><span class="s1">,</span><span class="se">\&#39;</span><span class="s1">&#39;</span>

    <span class="c1"># Cleanup + schema for PREDICT call</span>
    <span class="n">SQL_PRED_TRIGGER</span> <span class="o">=</span> <span class="n">SQL_PRED_TRIGGER</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;||&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;,</span><span class="se">\n\&#39;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">schema_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                                                                                                           <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span>
        <span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">);END&#39;</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">SQL_PRED_TRIGGER</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">splice_context</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">SQL_PRED_TRIGGER</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="create_parsing_trigger"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.create_parsing_trigger">[docs]</a><span class="k">def</span> <span class="nf">create_parsing_trigger</span><span class="p">(</span><span class="n">splice_context</span><span class="p">:</span> <span class="n">PySpliceContext</span><span class="p">,</span> <span class="n">schema_table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">primary_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                           <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">classes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">model_type</span><span class="p">:</span> <span class="n">Enum</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates the secondary trigger that parses the results of the first trigger and updates the prediction row populating the relevant columns</span>

<span class="sd">    :param splice_context: (PySpliceContext) the PySpliceContext</span>
<span class="sd">    :param schema_table_name: (str) the schema.table to create the table under</span>
<span class="sd">    :param primary_key: List[Tuple[str,str]] column name, SQL datatype for the primary key(s) of the table</span>
<span class="sd">    :param run_id: (str) the run_id to deploy the model under</span>
<span class="sd">    :param classes: (List[str]) the labels of the model (if they exist)</span>
<span class="sd">    :param model_type: (Enum) the model type (H2OModelType or SparkModelType)</span>
<span class="sd">    :param verbose: (bool) whether to print the SQL quer</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="n">schema_table_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">SQL_PARSE_TRIGGER</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;CREATE TRIGGER </span><span class="si">{</span><span class="n">schema</span><span class="si">}</span><span class="s1">.PARSERESULT_</span><span class="si">{</span><span class="n">schema_table_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="s1">&#39;</span> \
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> </span><span class="se">\t</span><span class="s1">BEFORE INSERT</span><span class="se">\n</span><span class="s1"> </span><span class="se">\t</span><span class="s1">ON </span><span class="si">{</span><span class="n">schema_table_name</span><span class="si">}</span><span class="se">\n</span><span class="s1"> </span><span class="se">\t</span><span class="s1">REFERENCING NEW AS NEWROW</span><span class="se">\n</span><span class="s1">&#39;</span> \
                        <span class="sa">f</span><span class="s1">&#39; </span><span class="se">\t</span><span class="s1">FOR EACH ROW</span><span class="se">\n</span><span class="s1"> </span><span class="se">\t\t</span><span class="s1">BEGIN ATOMIC</span><span class="se">\n\t</span><span class="s1"> set &#39;</span>
    <span class="n">set_prediction_case_str</span> <span class="o">=</span> <span class="s1">&#39;NEWROW.PREDICTION=</span><span class="se">\n\t\t</span><span class="s1">CASE</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">classes</span><span class="p">):</span>
        <span class="n">SQL_PARSE_TRIGGER</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;NEWROW.&quot;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">&quot;=MLMANAGER.PARSEPROBS(NEWROW.prediction,</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">),&#39;</span>
        <span class="n">set_prediction_case_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">WHEN MLMANAGER.GETPREDICTION(NEWROW.prediction)=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> then </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span>

    <span class="n">set_prediction_case_str</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">END;&#39;</span>
    <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="n">H2OModelType</span><span class="o">.</span><span class="n">KEY_VALUE</span><span class="p">:</span>  <span class="c1"># These models don&#39;t have an actual prediction</span>
        <span class="n">SQL_PARSE_TRIGGER</span> <span class="o">=</span> <span class="n">SQL_PARSE_TRIGGER</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;END&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">SQL_PARSE_TRIGGER</span> <span class="o">+=</span> <span class="n">set_prediction_case_str</span> <span class="o">+</span> <span class="s1">&#39;END&#39;</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">SQL_PARSE_TRIGGER</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">splice_context</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">SQL_PARSE_TRIGGER</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="get_feature_columns_and_types"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.get_feature_columns_and_types">[docs]</a><span class="k">def</span> <span class="nf">get_feature_columns_and_types</span><span class="p">(</span><span class="n">splice_ctx</span><span class="p">:</span> <span class="n">PySpliceContext</span><span class="p">,</span>
                                   <span class="n">df</span><span class="p">:</span> <span class="n">SparkDF</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
                                   <span class="n">create_model_table</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                                   <span class="n">model_cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
                                   <span class="n">schema_table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets the features and their data types for the table of the deployed model</span>

<span class="sd">    :param df: The dataframe or None</span>
<span class="sd">    :param create_model_table: bool if the user wants to create the table</span>
<span class="sd">    :param schema_table_name: The table in question</span>
<span class="sd">    :param model_cols: List[str] the columns that go into the feature vector for the model or None</span>
<span class="sd">    :return: (Tuple[List[str], Dict[str,str]]) The ordered feature columns as well as the schema types</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">create_model_table</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SparkDF</span><span class="p">,</span> <span class="n">PandasDF</span><span class="p">),</span> <span class="s2">&quot;Dataframe must be a PySpark or Pandas dataframe!&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="n">PandasDF</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">splice_ctx</span><span class="o">.</span><span class="n">spark_session</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model_cols</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">*</span><span class="n">model_cols</span><span class="p">)</span>
        <span class="n">feature_columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
        <span class="c1"># Get the datatype of each column in the dataframe</span>
        <span class="n">schema_types</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">):</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;[0-9,()]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">dataType</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">schema</span><span class="p">}</span>
    <span class="c1"># Else they are deploying to an existing table</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">splice_ctx</span><span class="o">.</span><span class="n">tableExists</span><span class="p">(</span><span class="n">schema_table_name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SpliceMachineException</span><span class="p">(</span><span class="s2">&quot;You&#39;ve tried to deploy a model to a table that does not exist. &quot;</span>
                                         <span class="s2">&quot;If you&#39;d like to create the table using this function, please pass in a dataframe&quot;</span>
                                         <span class="s2">&quot;and set create_model_table=True&quot;</span><span class="p">)</span>
        <span class="n">schema_from_table</span> <span class="o">=</span> <span class="n">splice_ctx</span><span class="o">.</span><span class="n">getSchema</span><span class="p">(</span><span class="n">schema_table_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model_cols</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">model_cols</span><span class="p">])</span> <span class="c1"># set is O(1) lookup</span>
            <span class="n">schema_types</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">):</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;[0-9,()]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">dataType</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">schema_from_table</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">m</span><span class="p">}</span>
            <span class="n">feature_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">schema_from_table</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">m</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">feature_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">schema_from_table</span><span class="p">]</span>
            <span class="n">schema_types</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">):</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;[0-9,()]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">dataType</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">schema_from_table</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">feature_columns</span><span class="p">,</span> <span class="n">schema_types</span></div>

<div class="viewcode-block" id="get_df_for_mleap"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.get_df_for_mleap">[docs]</a><span class="k">def</span> <span class="nf">get_df_for_mleap</span><span class="p">(</span><span class="n">splice_ctx</span><span class="p">:</span> <span class="n">PySpliceContext</span><span class="p">,</span>
                      <span class="n">schema_table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                      <span class="n">df</span><span class="p">:</span> <span class="n">SparkDF</span> <span class="ow">or</span> <span class="n">PandasDF</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SparkDF</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the dataframe for the deployment if the deployment is of a Spark model</span>
<span class="sd">    MLeap needs a dataframe in order to serialize the model. If it&#39;s not passed in, we need to get it from an existing table</span>

<span class="sd">    :param splice_ctx: PySpliceContext</span>
<span class="sd">    :param schema_table_name: str the table to get the dataframe from</span>
<span class="sd">    :param df: the dataframe if it exists or none</span>
<span class="sd">    :param create_model_table: bool if the user wants to create the table</span>
<span class="sd">    :return: (SparkDF) the dataframe</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">df</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="n">PandasDF</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">splice_ctx</span><span class="o">.</span><span class="n">spark_session</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="k">elif</span> <span class="ow">not</span> <span class="n">splice_ctx</span><span class="o">.</span><span class="n">tableExists</span><span class="p">(</span><span class="n">schema_table_name</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SpliceMachineException</span><span class="p">(</span><span class="s1">&#39;MLeap requires a dataframe to serialize a spark model. You must either pass in a &#39;</span>
                                     <span class="s1">&#39;dataframe to use for serialization or provide a table that already exists into this function.&#39;</span>
                                     <span class="s1">&#39;Note that the model will be deployed to that table.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">splice_ctx</span><span class="o">.</span><span class="n">df</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;select top 1 * from </span><span class="si">{</span><span class="n">schema_table_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="add_model_to_metadata"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.add_model_to_metadata">[docs]</a><span class="k">def</span> <span class="nf">add_model_to_metadata</span><span class="p">(</span><span class="n">splice_context</span><span class="p">:</span> <span class="n">PySpliceContext</span><span class="p">,</span>
                          <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                          <span class="n">schema_table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds the deployed model to the model_metadata table</span>

<span class="sd">    :param splice_context: (PySpliceContext) the PySpliceContext</span>
<span class="sd">    :param run_id: (str) the run_id of the deployment</span>
<span class="sd">    :param schema_table_name: (str) the SCHEMA.TABLE that the model was deployed to</span>
<span class="sd">    :return: (None)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">splice_context</span><span class="o">.</span><span class="n">tableExists</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">SQL</span><span class="o">.</span><span class="n">MLMANAGER_SCHEMA</span><span class="si">}</span><span class="s1">.MODEL_METADATA&#39;</span><span class="p">):</span>
        <span class="n">schema_table_name</span> <span class="o">=</span> <span class="n">schema_table_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">schema</span><span class="p">,</span> <span class="n">table</span> <span class="o">=</span> <span class="n">schema_table_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

        <span class="n">table_id</span> <span class="o">=</span> <span class="n">splice_context</span><span class="o">.</span><span class="n">df</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;select a.tableid from sys.systables a join sys.sysschemas b on a.schemaid=b.schemaid &quot;</span>
                                          <span class="sa">f</span><span class="s2">&quot;where a.tablename=&#39;</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">&#39; and b.schemaname=&#39;</span><span class="si">{</span><span class="n">schema</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">trigger_name_1</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;RUNMODEL_</span><span class="si">{</span><span class="n">schema_table_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">trigger_id_1</span><span class="p">,</span> <span class="n">create_ts</span> <span class="o">=</span> <span class="n">splice_context</span><span class="o">.</span><span class="n">df</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;select triggerid, varchar(creationtimestamp) from sys.systriggers &quot;</span>
                                                    <span class="sa">f</span><span class="s2">&quot;where triggername=&#39;</span><span class="si">{</span><span class="n">trigger_name_1</span><span class="si">}</span><span class="s2">&#39; and tableid=&#39;</span><span class="si">{</span><span class="n">table_id</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>\
                                                    <span class="o">.</span><span class="n">collect</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Not all models will have a second trigger</span>
        <span class="n">trigger_name_2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;PARSERESULT_</span><span class="si">{</span><span class="n">schema_table_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">trigger_id_2</span> <span class="o">=</span> <span class="n">splice_context</span><span class="o">.</span><span class="n">df</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;select triggerid from sys.systriggers where triggername=&#39;</span><span class="si">{</span><span class="n">trigger_name_2</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                                         <span class="sa">f</span><span class="s2">&quot;and tableid=&#39;</span><span class="si">{</span><span class="n">table_id</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="c1"># Adding extra single quote to trigger_id_2  case NULL</span>
        <span class="n">trigger_id_2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">trigger_id_2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">if</span> <span class="n">trigger_id_2</span> <span class="k">else</span> <span class="s1">&#39;NULL&#39;</span>

        <span class="c1"># We don&#39;t add the quotes around trigger_id_2 here because we handle it above in the NULL case</span>
        <span class="n">splice_context</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;INSERT INTO </span><span class="si">{</span><span class="n">SQL</span><span class="o">.</span><span class="n">MLMANAGER_SCHEMA</span><span class="si">}</span><span class="s2">.MODEL_METADATA&quot;</span>
                               <span class="sa">f</span><span class="s2">&quot;(RUN_UUID, ACTION, TABLEID, TRIGGER_TYPE, TRIGGERID, TRIGGERID_2, DB_ENV, DB_USER, ACTION_DATE)&quot;</span>
                               <span class="sa">f</span><span class="s2">&quot;values (&#39;</span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="s2">&#39;, &#39;DEPLOYED&#39;, &#39;</span><span class="si">{</span><span class="n">table_id</span><span class="si">}</span><span class="s2">&#39;, &#39;INSERT&#39;, &#39;</span><span class="si">{</span><span class="n">trigger_id_1</span><span class="si">}</span><span class="s2">&#39;, </span><span class="si">{</span><span class="n">trigger_id_2</span><span class="si">}</span><span class="s2">,&quot;</span>
                               <span class="sa">f</span><span class="s2">&quot;&#39;PROD&#39;, &#39;</span><span class="si">{</span><span class="n">get_user</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39;, &#39;</span><span class="si">{</span><span class="n">create_ts</span><span class="si">}</span><span class="s2">&#39;)&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="drop_tables_on_failure"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.utilities.drop_tables_on_failure">[docs]</a><span class="k">def</span> <span class="nf">drop_tables_on_failure</span><span class="p">(</span><span class="n">splice_context</span><span class="p">:</span> <span class="n">PySpliceContext</span><span class="p">,</span>
                           <span class="n">schema_table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                           <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                           <span class="n">model_already_exists</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attempts to roll back transactions from the deploy_db function on failure</span>

<span class="sd">    Due to some limitations DB-7726 we can&#39;t use fully utilize a single consistent JDBC connection using NSDS</span>
<span class="sd">    So we will try to rollback on failure using basic logic.</span>

<span class="sd">    If the model was already in the models table (ie it had been deployed before), we will leave it. Otherwise, delete</span>
<span class="sd">    Leave the tables.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># splice_context.execute(f&#39;DROP TABLE IF EXISTS {schema_table_name}&#39;)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">model_already_exists</span><span class="p">:</span>
        <span class="n">splice_context</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;DELETE FROM </span><span class="si">{</span><span class="n">SQL</span><span class="o">.</span><span class="n">MLMANAGER_SCHEMA</span><span class="si">}</span><span class="s1">.MODELS WHERE RUN_UUID=</span><span class="se">\&#39;</span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span></div>

<span class="n">ModelUtils</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">DBLibraries</span><span class="o">.</span><span class="n">MLeap</span><span class="p">:</span> <span class="n">SparkUtils</span><span class="p">,</span>
    <span class="n">DBLibraries</span><span class="o">.</span><span class="n">H2OMOJO</span><span class="p">:</span> <span class="n">H2OUtils</span><span class="p">,</span>
    <span class="n">DBLibraries</span><span class="o">.</span><span class="n">Keras</span><span class="p">:</span> <span class="n">KerasUtils</span><span class="p">,</span>
    <span class="n">DBLibraries</span><span class="o">.</span><span class="n">SKLearn</span><span class="p">:</span> <span class="n">SKUtils</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Splice Machine

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>